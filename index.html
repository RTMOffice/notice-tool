<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTM Letter Drop Tool (Release 1.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Open+Sans:wght@400;700&family=Tinos:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Basic styling */
        body { font-family: 'Inter', sans-serif; }
        iframe { width: 100%; height: 100%; border: 1px solid #ccc; border-radius: 0.375rem; }

        /* Style for the plan preview area */
        #planPreview {
            border: 1px solid #ccc; border-radius: 0.375rem; /* Tailwind: border border-gray-300 rounded-md */
            display: flex; justify-content: center; align-items: center; /* Tailwind: flex justify-center items-center */
            overflow: auto; background-color: #f9fafb; padding: 0; /* Tailwind: overflow-auto bg-gray-50 p-0 */
            text-align: center; /* Tailwind: text-center */
            width: 100%; max-width: 1000px; height: 600px; /* Tailwind: w-full max-w-5xl h-[600px] */
            margin-left: auto; margin-right: auto; /* Tailwind: mx-auto */
        }
        #planPreview img { max-width: 100%; max-height: 100%; object-fit: contain; display: block; margin: auto; } /* Tailwind: max-w-full max-h-full object-contain block mx-auto */
        #planPreview iframe { width: 100%; height: 100%; border: none; border-radius: 0.375rem; } /* Tailwind: w-full h-full border-none rounded-md */

        /* Container for map iframe */
        .map-container {
            position: relative; width: 100%; max-width: 1000px; height: 600px; /* Tailwind: relative w-full max-w-5xl h-[600px] */
            margin-left: auto; margin-right: auto; /* Tailwind: mx-auto */
            overflow: hidden; border: 1px solid #ccc; border-radius: 0.375rem; /* Tailwind: overflow-hidden border border-gray-300 rounded-md */
        }
        .map-container iframe { width: 100%; height: 100%; border: none; } /* Tailwind: w-full h-full border-none */

        /* Style for button nested at bottom of map container */
        #copyCoordsBtn {
            position: absolute; bottom: 10px; left: 50%; /* Tailwind: absolute bottom-2.5 left-1/2 */
            transform: translateX(-50%); z-index: 10; /* Tailwind: -translate-x-1/2 z-10 */
        }

        /* Hide steps initially */
        .step { display: none; } /* Tailwind: hidden */
        #step1 { display: block; } /* Tailwind: block (or remove hidden for the first step if using JS to manage visibility) */

        /* Add a subtle border between form groups in Step 1 */
        #step1 .form-group + .form-group {
            border-top: 1px solid #e5e7eb; padding-top: 1.5rem; margin-top: 1.5rem; /* Tailwind: border-t border-gray-200 pt-6 mt-6 */
        }
        /* Add margin between instruction boxes */
        #searchInstructionBox + #columnCBox {
            margin-top: 1rem; /* Tailwind: mt-4 */
        }


        /* Grid for side-by-side layout and spacing */
        .map-plan-grid {
            display: grid; /* Tailwind: grid */
            grid-template-columns: repeat(1, minmax(0, 1fr)); /* Tailwind: grid-cols-1 */
            gap: 1rem; /* Tailwind: gap-4 */
        }
        @media (min-width: 768px) { /* md breakpoint */
            .map-plan-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr)); /* Tailwind: md:grid-cols-2 */
            }
        }


        /* Styles for the printable notice area */
        #noticePrintArea {
            display: none; /* Hidden by default */
            font-family: 'Open Sans', sans-serif;
            color: black;
            width: 210mm; /* A4 width */
            padding: 15mm; /* Standard margins */
            box-sizing: border-box;
            background-color: white;
        }
        /* Font Substitutes & Sizes */
        #noticePrintArea .font-times { font-family: 'Tinos', serif; }
        #noticePrintArea .print-text-10pt { font-size: 10pt; line-height: 1.1; }
        #noticePrintArea .print-text-11pt { font-size: 11pt; line-height: 1.25; }
        #noticePrintArea .print-text-12pt { font-size: 12pt; line-height: 1.25; }
        #noticePrintArea .print-text-22pt { font-size: 22pt; line-height: 1.2; }
        #noticePrintArea .print-text-24pt { font-size: 24pt; line-height: 1.2; }
        #noticePrintArea .font-bold { font-weight: 700; }
        #noticePrintArea .underline { text-decoration: underline; }
        #noticePrintArea .text-center { text-align: center; }
        #noticePrintArea .text-right { text-align: right; }
        /* Spacing Helpers */
        #noticePrintArea .mt-4 { margin-top: 4mm; }
        #noticePrintArea .mt-5 { margin-top: 5mm; }
        #noticePrintArea .mt-8 { margin-top: 8mm; }
        #noticePrintArea .mt-10 { margin-top: 10mm; }
        #noticePrintArea .mt-15 { margin-top: 15mm; }
        #noticePrintArea .mb-4 { margin-bottom: 4mm; }
        #noticePrintArea .mb-5 { margin-bottom: 5mm; }
        #noticePrintArea .mb-10 { margin-bottom: 10mm; }
        /* Float/Clear */
        #noticePrintArea .float-right { float: right; }
        #noticePrintArea .clear-both { clear: both; }
        /* Logo & Address Specific */
        #noticePrintArea .logo-container {
            width: 59.8mm; height: 11.4mm; float: right;
            margin-bottom: 5mm; text-align: right;
        }
         #noticePrintArea .logo-container img {
            max-width: 100%; max-height: 100%; display: inline-block;
         }
        #noticePrintArea .address-block {
            float: right; text-align: right; clear: right; margin-top: 5mm; width: 60mm;
        }
        #noticePrintArea p { margin-bottom: 5mm; }
        #noticePrintArea #print-closing p { margin-bottom: 1mm; margin-top: 1mm; }
        /* Apply 1.25 line height specifically to body paragraphs */
        #noticePrintArea .body-para { line-height: 1.25 !important; }


        /* Print-specific styles */
        @media print {
            body * { visibility: hidden; }
            #noticePrintArea, #noticePrintArea * { visibility: visible; }
            #noticePrintArea {
                position: absolute; left: 0; top: 0;
                width: 100%; height: auto;
                padding: 15mm; margin: 0; border: none; box-shadow: none;
                display: block !important; /* Ensure it's block for printing */
            }
            @page {
                margin: 0mm; size: A4 portrait;
            }
            body { margin: 0 !important; padding: 0 !important; }
        }

    </style>
</head>
<body class="bg-gray-100 p-4">

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 bg-white rounded-lg shadow-lg border border-gray-200" id="toolInterface">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">RTM Letter Drop Tool (Release 1.0)</h1>

        <div id="step1" class="step space-y-6">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Step 1: Data collection</h2>

            <div id="searchInstructionBox" class="p-4 rounded-md border-2 border-[#c31f33] text-gray-700 mb-6" style="display: none;">
                Search job number in folder: <strong id="searchRefNumber">[Job Number]</strong>
            </div>
            <div id="columnCBox" class="p-4 rounded-md border-2 border-[#c31f33] text-gray-700 bg-red-50" style="display: none;">
                Times: <strong id="columnCData">[Data]</strong>
            </div>

            <div class="form-group bg-blue-50 p-4 rounded-md border border-blue-200">
                <label for="pasteArea" class="block text-sm font-bold text-gray-700 mb-1">Copy and paste job row from planned WB</label>
                <p class="text-xs text-gray-600 mb-2">Date (Col A), Job Ref (Col H), Exchange (Col I), Full Address (Col P), Times (Col C).</p>
                <textarea id="pasteArea" placeholder="Paste row data here..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm font-mono min-h-[80px]"></textarea>
                <button id="parseAndNextBtn" class="mt-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">Save Job Details</button>
                <p id="pasteError" class="text-red-600 text-sm mt-2"></p>
                <p id="pasteSuccess" class="text-green-600 text-sm mt-2"></p>
            </div>

            <div class="form-group bg-green-50 p-4 rounded-md border border-green-200">
               <label for="planFile" class="block text-sm font-bold text-gray-700 mb-1">Upload TM Plan</label>
               <input type="file" id="planFile" accept="image/*,application/pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <p class="text-xs text-gray-600 mt-1">Accepts images or PDF. PDF viewing requires a browser viewer/extension.</p>
                <p id="planError" class="text-red-600 text-sm mt-2"></p>
                <p id="planSuccess" class="text-green-600 text-sm mt-2"></p>
           </div>

            <div class="form-group bg-yellow-50 p-4 rounded-md border border-yellow-200">
                <label for="diversionRouteStep1" class="block text-sm font-bold text-gray-700 mb-1">Enter diversion route</label>
                <textarea id="diversionRouteStep1" rows="3" placeholder="Enter diversion route details..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
            </div>

            <div class="mt-8 text-right">
                <button id="nextToStep3Combined" disabled class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">Next: Review Map & Plan</button>
            </div>
        </div>

        <div id="step3" class="step">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Step 2: Review Map/Plan & Enter Details</h2>

            <div class="map-plan-grid mb-6 mt-6">
                <div class="mb-4 md:mb-0 flex flex-col items-center">
                    <h3 class="text-lg font-medium text-gray-800 mb-2 w-full max-w-[1000px]">Map Location</h3>
                    <div class="map-container">
                        <iframe id="mapFrame" src="about:blank" title="Location Map"></iframe>
                        <button id="copyCoordsBtn" title="Copy coordinates to clipboard" class="py-2 px-4 text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:ring-indigo-500 shadow-md rounded-md">Copy Coordinates</button>
                    </div>
                    <p id="copyCoordsStatus" class="text-sm text-green-600 mt-2 h-4"></p>
                    <p id="mapSearchStatus" class="hidden"></p> </div>
                <div class="flex flex-col items-center">
                    <h3 class="text-lg font-medium text-gray-800 mb-2 w-full max-w-[1000px]">Uploaded Plan</h3>
                    <div id="planPreview">
                        <p class="text-gray-500 text-sm">Plan preview will appear here.</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                <div class="form-group">
                    <label for="streetInput" class="block text-sm font-medium text-gray-700 mb-1">Street:</label>
                    <input type="text" id="streetInput" placeholder="Enter street name from map" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="form-group">
                    <label for="townInput" class="block text-sm font-medium text-gray-700 mb-1">Town:</label>
                    <input type="text" id="townInput" placeholder="Enter town name from map" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="form-group">
                    <label for="workDays" class="block text-sm font-medium text-gray-700 mb-1">Number of Working Days:</label>
                    <input type="number" id="workDays" min="1" value="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="form-group">
                    <label for="affectedHouses" class="block text-sm font-medium text-gray-700 mb-1">Required Letters:</label>
                    <input type="number" id="affectedHouses" min="0" max="40" placeholder="e.g. 40" class="mt-1 block w-full px-3 py-2 bg-white border-2 border-[#c31f33] rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reference Number:</label>
                    <input type="text" id="refNumberDisplay" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date (adjusted):</label>
                    <input type="text" id="dateDisplay" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
                <div class="form-group md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Coordinates (extracted Lat, Lon):</label>
                    <input type="text" id="coordsDisplay" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
            </div>

            <div class="mt-8 flex justify-between">
                <button class="secondary-button inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="showStep('step1')">Back</button>
                <button id="generateNoticeBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Next: Generate Notice</button>
            </div>
        </div>

        <div id="step4" class="step">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Step 3: Generated Notice Text</h2>
            <p class="mb-4 mt-6 text-sm text-gray-600">Review the generated text below. Copy and paste into your Word template or use the Print button.</p>
            <textarea id="generatedNotice" rows="20" readonly class="w-full p-3 border border-gray-300 rounded bg-gray-50 font-mono text-sm shadow-sm"></textarea>
            <div class="mt-6 flex justify-between items-center">
                <button class="secondary-button inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="showStep('step3')">Back</button>
                <div class="flex items-center">
                    <div id="printCopiesDisplay" class="border-2 border-[#c31f33] rounded-md px-4 py-2 text-sm font-medium text-gray-700 mr-4">
                        Print 0
                    </div>
                    <button id="printNoticeBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Print Notice</button>
                </div>
            </div>
        </div>

        <div id="step5" class="step space-y-6">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Step 4: Final Actions</h2>

            <div class="bg-blue-50 p-4 rounded-md border border-blue-200">
                <h3 class="text-lg font-medium text-gray-800 mb-2">1. Print TM Plan</h3>
                <p class="text-sm text-gray-600 mb-3">Click the button below to open the uploaded TM plan in a new tab for printing.</p>
                <button id="viewPlanBtn" class="secondary-button inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">View/Print TM Plan</button>
            </div>

            <div class="bg-yellow-50 p-4 rounded-md border border-yellow-200">
                <h3 class="text-lg font-medium text-gray-800 mb-2">2. Prepare Post-it Note</h3>
                <p class="text-sm text-gray-600 mb-3">Write the following details on a post-it note:</p>
                <div id="postItDetails" class="p-3 bg-white border border-gray-200 rounded-md text-sm font-mono">
                    Loading...
                </div>
            </div>

            <div class="bg-purple-50 p-4 rounded-md border border-purple-200">
                <h3 class="text-lg font-medium text-gray-800 mb-2">3. Update Spreadsheet</h3>
                <p class="text-sm text-gray-600">Remember to update your main tracking spreadsheet with the relevant details for this notice.</p>
                <div class="mt-4 flex items-center">
                    <input id="wbUpdatedCheckbox" name="wbUpdatedCheckbox" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="wbUpdatedCheckbox" class="ml-2 block text-sm text-gray-900"> I have updated the WB </label>
                </div>
            </div>

            <div class="mt-8 flex justify-between items-center">
                <button class="secondary-button inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="showStep('step4')">Back</button>
                <button id="finaliseDropBtn" disabled class="inline-flex justify-center py-2 px-6 border-2 border-green-500 shadow-sm text-base font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed">New Notice</button>
            </div>
        </div>


    </div> <div id="noticePrintArea">
        <div class="logo-container">
            <img id="print-logo-img" src="https://raw.githubusercontent.com/RTMOffice/notice-tool/refs/heads/main/Logo.jpg" alt="Company Logo">
        </div>
        <div class="address-block print-text-10pt">
            <div>I & A Communications</div>
            <div>Burgon House</div>
            <div>James Swallow Way</div>
            <div>London and Medway Commercial</div>
            <div>Rochester</div>
            <div>Kent</div>
            <div>ME3 9GX</div>
            <div class="mt-4">Tel:      0845 200 4035</div>
        </div>
        <div class="clear-both mb-10"></div> <div class="mt-15 font-times print-text-22pt font-bold" id="print-please-note">PLEASE NOTE</div>
        <div class="mt-4 print-text-24pt underline text-center" id="print-date">On DATE</div>
        <p class="mt-10 print-text-11pt body-para" id="print-para1">
            I&A Communications working on behalf of BT Openreach are responsible for maintaining the network that provides you with your communications service regardless of which telephony or broadband supplier you are using and have been tasked in replacing a BT pole along <strong class="font-bold" id="print-para1-street-town">STREET, TOWN</strong>.
        </p>
        <p class="print-text-11pt body-para" id="print-para2">
            The work is expected to take a maximum of <strong class="font-bold" id="print-para2-days">DAY working days</strong> and during this time there will be a road closure in place. Access will be maintained for residents, but we ask for your patience while our engineers make way as this can take some time, alternatively you can follow our diversion <strong class="font-bold" id="print-para2-div">DIV</strong> and Vice Versa.
        </p>
        <p class="print-text-11pt body-para" id="print-para3">
            <strong class="font-bold" id="print-para3-street-town">STREET, TOWN</strong> will be closed during the hours of 09:00am and 17:00pm, the road will be reopened outside these times.
        </p>
        <p class="print-text-11pt font-bold body-para" id="print-apology">
            We would like to apologise if this work causes any inconvenience and would also like to thank you in advance for your co-operation.
        </p>
        <p class="print-text-12pt body-para" id="print-concerns">
            ANY CONCERNS PLEASE CALL <strong class="font-bold" id="print-concerns-phone">0845 200 4035</strong> WITH OUR REF: <span id="print-concerns-ref">REFR</span>
        </p>
        <div class="mt-10 print-text-11pt body-para" id="print-closing">
            <p>Regards</p>
            <p class="mt-4">Zoe Franks</p>
            <p>I & A Communications Ltd</p>
            <p>Tel: 0845 200 4035</p>
        </div>
    </div>


    <script>
        // --- Global Variables ---
        let planFileUrl = null; // Stores the object URL for the uploaded plan file
        // Object to store all notice-related data extracted and entered by the user
        let noticeData = {
            ref: '',          // Job reference number
            lat: '',          // Latitude
            lon: '',          // Longitude
            date: '',         // Formatted work start date
            street: '',       // Street name for the notice
            town: '',         // Town name for the notice
            days: '2',        // Number of working days, DEFAULT TO 2
            diversion: '',    // Diversion route details
            houses: '',       // Number of affected houses (for print count)
            postcode: '',     // Postcode (currently not used but reserved)
            locationName: '', // Exchange or general location name
            fullAddress: '',  // Full address from pasted data (for post-it)
            columnCData: ''   // Data from Column C (Times)
        };
        let dataParsed = false;    // Flag to track if spreadsheet data has been successfully parsed
        let planUploaded = false;  // Flag to track if a TM plan has been successfully uploaded

        // --- DOM Elements ---
        // General UI elements
        const steps = document.querySelectorAll('.step'); // Collection of all step divs
        const pasteArea = document.getElementById('pasteArea'); // Textarea for pasting spreadsheet data
        const pasteError = document.getElementById('pasteError'); // Paragraph for displaying paste errors
        const pasteSuccess = document.getElementById('pasteSuccess'); // Paragraph for displaying paste success
        const planFileInput = document.getElementById('planFile'); // File input for TM plan
        const planPreview = document.getElementById('planPreview'); // Div to show plan preview (image or iframe)
        const planError = document.getElementById('planError'); // Paragraph for plan upload errors
        const planSuccess = document.getElementById('planSuccess'); // Paragraph for plan upload success
        const diversionRouteStep1Input = document.getElementById('diversionRouteStep1'); // Textarea for diversion route in Step 1
        const mapFrame = document.getElementById('mapFrame'); // Iframe for displaying the map
        const mapSearchStatus = document.getElementById('mapSearchStatus'); // Status for map search (currently hidden)
        const streetInput = document.getElementById('streetInput'); // Input for street name in Step 2
        const townInput = document.getElementById('townInput'); // Input for town name in Step 2
        const workDaysInput = document.getElementById('workDays'); // Input for number of working days
        const affectedHousesInput = document.getElementById('affectedHouses'); // Input for number of affected houses/letters
        const refNumberDisplay = document.getElementById('refNumberDisplay'); // Readonly input to display parsed reference number
        const dateDisplay = document.getElementById('dateDisplay'); // Readonly input to display parsed and formatted date
        const coordsDisplay = document.getElementById('coordsDisplay'); // Readonly input to display extracted coordinates
        const copyCoordsBtn = document.getElementById('copyCoordsBtn'); // Button to copy coordinates
        const copyCoordsStatus = document.getElementById('copyCoordsStatus'); // Status message for coordinate copy
        const generatedNoticeTextarea = document.getElementById('generatedNotice'); // Textarea to display the generated notice text
        const printNoticeBtn = document.getElementById('printNoticeBtn'); // Button to trigger printing the notice
        const printCopiesDisplay = document.getElementById('printCopiesDisplay'); // Div to show how many copies to print
        const searchInstructionBox = document.getElementById('searchInstructionBox'); // Info box for searching job number
        const searchRefNumber = document.getElementById('searchRefNumber'); // Span within info box for job number
        const columnCBox = document.getElementById('columnCBox'); // Info box for Column C data
        const columnCData = document.getElementById('columnCData'); // Span within info box for Column C data

        // Step 4 (Final Actions) Elements
        const postItDetails = document.getElementById('postItDetails'); // Div to display details for the post-it note
        const viewPlanBtn = document.getElementById('viewPlanBtn'); // Button to view/print the TM plan
        const finaliseDropBtn = document.getElementById('finaliseDropBtn'); // Button to finalise and start a new notice
        const wbUpdatedCheckbox = document.getElementById('wbUpdatedCheckbox'); // Checkbox to confirm WB update


        // --- Navigation Buttons ---
        const parseAndNextBtn = document.getElementById('parseAndNextBtn'); // Button in Step 1 to parse data
        const nextToStep3CombinedBtn = document.getElementById('nextToStep3Combined'); // Button in Step 1 to proceed to Step 2 (Review Map/Plan)
        const generateNoticeBtn = document.getElementById('generateNoticeBtn'); // Button in Step 2 to generate the notice text

        // --- Functions ---

        /**
         * Shows the specified step and hides others.
         * @param {string} stepId - The ID of the step div to display.
         */
        function showStep(stepId) {
            console.log("Showing step:", stepId);
            steps.forEach(step => {
                step.style.display = (step.id === stepId) ? 'block' : 'none';
            });
            window.scrollTo(0, 0); // Scroll to the top of the page
            // Reset "WB Updated" checkbox and "New Notice" button when navigating away from the final step
            if (stepId !== 'step5' && wbUpdatedCheckbox) {
                wbUpdatedCheckbox.checked = false;
                finaliseDropBtn.disabled = true;
            }
        }

        /**
         * Checks if conditions are met to enable the "Next: Review Map & Plan" button in Step 1.
         * Requires data to be parsed and a plan to be uploaded.
         */
        function checkEnableStep1NextButton() {
            if (dataParsed && planUploaded) {
                nextToStep3CombinedBtn.disabled = false;
                console.log("Step 1 Next button enabled.");
            } else {
                nextToStep3CombinedBtn.disabled = true;
                console.log("Step 1 Next button disabled. Data Parsed:", dataParsed, "Plan Uploaded:", planUploaded);
            }
        }

        /**
         * Returns the correct ordinal suffix for a given day of the month.
         * @param {number} day - The day of the month.
         * @returns {string} The ordinal suffix (e.g., "st", "nd", "rd", "th").
         */
        function getDaySuffix(day) {
            if (day > 3 && day < 21) return 'th'; // Covers 4th-20th
            switch (day % 10) {
                case 1: return "st";
                case 2: return "nd";
                case 3: return "rd";
                default: return "th";
            }
        }

        /**
         * Parses the tab-separated data pasted by the user from the spreadsheet.
         * Extracts date, reference, exchange, location (for coordinates), and Column C data.
         * Attempts to extract number of days from Column C.
         * Validates data and updates the UI accordingly.
         */
        function parsePastedData() {
            console.log("parsePastedData called");
            pasteError.textContent = '';
            pasteSuccess.textContent = '';
            dataParsed = false;
            noticeData.days = '2'; // Reset to default 2 before parsing new data
            searchInstructionBox.style.display = 'none';
            columnCBox.style.display = 'none';
            checkEnableStep1NextButton();

            const pastedText = pasteArea.value.trim();
            if (!pastedText) {
                pasteError.textContent = 'Please paste data.';
                return;
            }
            const columns = pastedText.split('\t');

            if (columns.length <= 15) {
                pasteError.textContent = `Error: Need at least 16 columns for all required data (found ${columns.length}). Please check the copied row.`;
                return;
            }

            try {
                // 1. Date Extraction
                let rawDateStr = columns[0]?.trim();
                if (!rawDateStr) throw new Error("Date (Col A) is missing or empty.");
                let parsedDate;
                let tempDate = new Date(rawDateStr);
                if (!isNaN(tempDate.getTime())) {
                    parsedDate = tempDate;
                } else {
                    const dateParts = rawDateStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
                    if (dateParts) {
                        const day = parseInt(dateParts[1], 10), month = parseInt(dateParts[2], 10) - 1;
                        let year = parseInt(dateParts[3], 10); if (year < 100) year += 2000;
                        parsedDate = new Date(Date.UTC(year, month, day));
                        if (isNaN(parsedDate.getTime())) throw new Error(`Invalid date components in "${rawDateStr}".`);
                    } else {
                        const potentialSerial = Number(rawDateStr);
                        if (!isNaN(potentialSerial) && potentialSerial > 1 && potentialSerial < 2958466) {
                            const excelEpochOffset = 25569;
                            const jsTimestamp = (potentialSerial - excelEpochOffset) * 86400 * 1000;
                            parsedDate = new Date(jsTimestamp);
                            if (isNaN(parsedDate.getTime())) throw new Error(`Invalid Excel serial date: "${rawDateStr}".`);
                        } else {
                            throw new Error(`Unrecognized date format: "${rawDateStr}". Please use DD/MM/YYYY, YYYY-MM-DD, or Excel serial number.`);
                        }
                    }
                }
                const today = new Date(), currentYear = today.getUTCFullYear();
                const comparisonDateThisYear = new Date(Date.UTC(currentYear, parsedDate.getUTCMonth(), parsedDate.getUTCDate()));
                const todayDateOnly = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
                let finalYear = comparisonDateThisYear < todayDateOnly ? currentYear + 1 : currentYear;
                parsedDate.setUTCFullYear(finalYear);
                const dayOfMonth = parsedDate.getUTCDate();
                const weekday = parsedDate.toLocaleDateString('en-GB', { weekday: 'long', timeZone: 'UTC' }).toUpperCase();
                const monthName = parsedDate.toLocaleDateString('en-GB', { month: 'long', timeZone: 'UTC' }).toUpperCase();
                const yearNum = parsedDate.getUTCFullYear();
                noticeData.date = `${weekday} ${dayOfMonth + getDaySuffix(dayOfMonth)} ${monthName} ${yearNum}`;

                // 2. Reference (Column H, index 7)
                noticeData.ref = columns[7]?.trim();
                if (!noticeData.ref) throw new Error("Reference (Col H) is missing or empty.");

                // 3. Location Name / Exchange (Column I, index 8)
                noticeData.locationName = columns[8]?.trim();
                if (!noticeData.locationName) throw new Error("Exchange/Location Name (Col I) is missing or empty.");

                // 4. Full Address / Coordinates (Column P, index 15)
                let locationString = columns[15]?.trim();
                if (!locationString) throw new Error("Location data (Col P) is missing or empty.");
                noticeData.fullAddress = locationString;
                const coordRegex = /.*?(-?\d{1,3}(?:\.\d+)?)\s*,\s*(-?\d{1,3}(?:\.\d+)?)/;
                const coordMatch = locationString.match(coordRegex);
                if (coordMatch && coordMatch[1] && coordMatch[2]) {
                    const lat = parseFloat(coordMatch[1]), lon = parseFloat(coordMatch[2]);
                    if (lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
                        noticeData.lat = String(lat); noticeData.lon = String(lon);
                    } else { throw new Error(`Coordinates out of valid range (Lat: ${lat}, Lon: ${lon}) in Col P.`); }
                } else { throw new Error("Could not find valid Latitude, Longitude in Col P. Expected format 'lat, lon'."); }

                // 5. Column C Data (Times, index 2) and Day Extraction
                noticeData.columnCData = columns[2]?.trim() || "";
                if (noticeData.columnCData) {
                    const daysRegex = /\b(\d+)\s*day(s)?\b/i; // Looks for "X day" or "X days"
                    const daysMatch = noticeData.columnCData.match(daysRegex);
                    if (daysMatch && daysMatch[1]) {
                        const extractedDays = parseInt(daysMatch[1], 10);
                        if (extractedDays > 0) { // Ensure it's a positive number
                           noticeData.days = String(extractedDays);
                           console.log(`Extracted ${noticeData.days} days from Column C.`);
                        }
                    }
                }

                console.log("Parsed Data (after Col C check):", noticeData);
                pasteSuccess.textContent = 'Data parsed successfully!';
                dataParsed = true;

                searchRefNumber.textContent = noticeData.ref;
                searchInstructionBox.style.display = 'block';
                if (noticeData.columnCData) {
                    columnCData.textContent = noticeData.columnCData;
                    columnCBox.style.display = 'block';
                } else {
                    columnCBox.style.display = 'none';
                }
                checkEnableStep1NextButton();

            } catch (error) {
                console.error("Parsing error:", error);
                pasteError.textContent = `Error: ${error.message}`;
                dataParsed = false;
                searchInstructionBox.style.display = 'none';
                columnCBox.style.display = 'none';
                checkEnableStep1NextButton();
                noticeData = { ref: '', lat: '', lon: '', date: '', street: '', town: '', days: '2', diversion: '', houses: '', postcode: '', locationName: '', fullAddress: '', columnCData: '' };
            }
        }


        /**
         * Handles the TM plan file upload.
         * Creates an object URL for preview and displays image or PDF.
         * @param {Event} event - The file input change event.
         */
        function handlePlanUpload(event) {
            console.log("handlePlanUpload started");
            const file = event.target.files[0];
            planError.textContent = '';
            planSuccess.textContent = '';
            planUploaded = false;
            checkEnableStep1NextButton();
            planPreview.innerHTML = '<p class="text-gray-500 text-sm">Processing plan...</p>';

            if (planFileUrl) { URL.revokeObjectURL(planFileUrl); planFileUrl = null; }
            if (!file) {
                planPreview.innerHTML = '<p class="text-gray-500 text-sm">No plan selected.</p>';
                return;
            }
            console.log("File selected:", file.name, "Type:", file.type);

            try {
                planFileUrl = URL.createObjectURL(file);
            } catch (e) {
                console.error("URL Creation Error:", e);
                planError.textContent = 'Could not create URL for the file.';
                planPreview.innerHTML = '<p class="text-red-500 text-sm">Error loading preview.</p>';
                planUploaded = false; checkEnableStep1NextButton(); return;
            }

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = planFileUrl;
                img.alt = "Plan Preview";
                img.onerror = () => {
                    planError.textContent = 'Could not display image. File might be corrupted or unsupported.';
                    planPreview.innerHTML = '<p class="text-red-500 text-sm">Error loading image preview.</p>';
                    URL.revokeObjectURL(planFileUrl); planFileUrl = null; planUploaded = false; checkEnableStep1NextButton();
                };
                img.onload = () => {
                    planPreview.innerHTML = ''; planPreview.appendChild(img);
                    planSuccess.textContent = `Image Plan "${file.name}" successfully uploaded.`;
                    planUploaded = true; checkEnableStep1NextButton();
                };
            } else if (file.type === 'application/pdf') {
                planPreview.innerHTML = '';
                const iframe = document.createElement('iframe');
                iframe.src = planFileUrl;
                iframe.title = "Plan PDF Preview";
                iframe.setAttribute('type', 'application/pdf');
                iframe.onload = () => { // May not be fully reliable for PDF rendering
                    planSuccess.textContent = `PDF Plan "${file.name}" uploaded. Preview depends on browser/extensions.`;
                    planUploaded = true; checkEnableStep1NextButton();
                };
                iframe.onerror = () => {
                    planError.textContent = 'Could not load PDF preview. Ensure browser can display PDFs.';
                    planPreview.innerHTML = '<p class="text-red-500 text-sm">Error loading PDF preview.</p>';
                    URL.revokeObjectURL(planFileUrl); planFileUrl = null; planUploaded = false; checkEnableStep1NextButton();
                };
                planPreview.appendChild(iframe);
            } else {
                planError.textContent = 'Unsupported file type. Please upload an Image or PDF.';
                planPreview.innerHTML = '<p class="text-red-500 text-sm">Invalid file type.</p>';
                URL.revokeObjectURL(planFileUrl); planFileUrl = null; planUploaded = false; checkEnableStep1NextButton();
            }
        }

        /**
         * Updates the map iframe source URL using the parsed coordinates.
         */
        function updateMap() {
            if (noticeData.lat && noticeData.lon) {
                const mapUrl = `https://symology.maps.arcgis.com/apps/webappviewer/index.html?id=1055c1d3a2c344cea5353d8ed744831c&center=${noticeData.lon},${noticeData.lat}&level=15`;
                mapFrame.src = mapUrl;
                console.log("Updated map URL to ArcGIS:", mapUrl);
            } else {
                mapFrame.src = 'about:blank';
                console.log("Map cleared due to missing coordinates.");
            }
        }

        /**
         * Attempts to auto-fill the search box within the ArcGIS map iframe.
         */
        function tryAutoFillMapSearch() {
            const coordsString = coordsDisplay.value;
            if (!coordsString || coordsString === 'N/A') return;
            console.log('Attempting auto-fill ArcGIS map search with:', coordsString);
            setTimeout(() => {
                try {
                    const iframeDoc = mapFrame.contentWindow?.document;
                    if (!iframeDoc) {
                        console.warn("Cannot access iframe content for auto-fill."); return;
                    }
                    const searchInput = iframeDoc.getElementById('esri_dijit_Search_0_input');
                    if (searchInput) {
                        searchInput.value = coordsString;
                        console.log("Attempted ArcGIS map search auto-fill.");
                    } else { console.warn("ArcGIS map search input 'esri_dijit_Search_0_input' not found."); }
                } catch (error) {
                    console.warn("ArcGIS Auto-fill failed:", error.message);
                }
            }, 3000);
        }

        /**
         * Copies the extracted coordinates to the clipboard.
         */
        function copyCoordinatesToClipboard() {
            const coordsString = coordsDisplay.value;
            copyCoordsStatus.textContent = '';
            if (!coordsString || coordsString === 'N/A') {
                copyCoordsStatus.textContent = 'No coordinates to copy.';
                copyCoordsStatus.className = 'text-sm text-yellow-600 mt-2 h-4'; return;
            }
            if (!navigator.clipboard || !navigator.clipboard.writeText) {
                copyCoordsStatus.textContent = 'Clipboard API not available (HTTPS/localhost needed).';
                copyCoordsStatus.className = 'text-sm text-red-600 mt-2 h-4'; return;
            }
            navigator.clipboard.writeText(coordsString).then(() => {
                copyCoordsStatus.textContent = 'Coordinates copied!';
                copyCoordsStatus.className = 'text-sm text-green-600 mt-2 h-4';
                setTimeout(() => { copyCoordsStatus.textContent = ''; }, 3000);
            }).catch(err => {
                console.error('Failed to copy coordinates:', err);
                copyCoordsStatus.textContent = 'Copy failed. Check permissions.';
                copyCoordsStatus.className = 'text-sm text-red-600 mt-2 h-4';
            });
        }

        /**
         * Generates the notice text based on user inputs and parsed data.
         */
        function generateNotice() {
            noticeData.street = streetInput.value.trim();
            noticeData.town = townInput.value.trim();
            if (!noticeData.street) { alert("Please enter the Street name."); streetInput.focus(); return; }
            if (!noticeData.town) { alert("Please enter the Town name."); townInput.focus(); return; }
            const streetAndTown = `${noticeData.street}, ${noticeData.town}`;

            // Use the value from the input field in Step 2, which might have been manually changed
            noticeData.days = workDaysInput.value || '2'; // Default to '2' if input is empty
            noticeData.houses = affectedHousesInput.value || '0';

            if (!noticeData.diversion) {
                alert("Diversion route is missing. Please go back to Step 1.");
                showStep('step1'); diversionRouteStep1Input.focus(); return;
            }

            document.getElementById('print-date').textContent = `On ${noticeData.date}`;
            document.getElementById('print-para1-street-town').textContent = streetAndTown;
            const daysText = `${noticeData.days} working day${parseInt(noticeData.days) === 1 ? '' : 's'}`;
            document.getElementById('print-para2-days').textContent = daysText;
            document.getElementById('print-para2-div').textContent = noticeData.diversion;
            document.getElementById('print-para3-street-town').textContent = streetAndTown;
            document.getElementById('print-concerns-ref').textContent = noticeData.ref;

            let textPreview = `I & A Communications Ltd\n\nTel: 0845 200 4035\n\nPLEASE NOTE\nOn ${noticeData.date}\n\n`;
            textPreview += `I&A Communications working on behalf of BT Openreach are responsible for maintaining the network that provides you with your communications service regardless of which telephony or broadband supplier you are using and have been tasked in replacing a BT pole along ${streetAndTown}.\n\n`;
            textPreview += `The work is expected to take a maximum of ${daysText} and during this time there will be a road closure in place. Access will be maintained for residents, but we ask for your patience while our engineers make way as this can take some time, alternatively you can follow our diversion ${noticeData.diversion} and Vice Versa.\n\n`;
            textPreview += `${streetAndTown} will be closed during the hours of 09:00am and 17:00pm, the road will be reopened outside these times.\n\n`;
            textPreview += `We would like to apologise if this work causes any inconvenience and would also like to thank you in advance for your co-operation.\n\n`;
            textPreview += `ANY CONCERNS PLEASE CALL 0845 200 4035 WITH OUR REF: ${noticeData.ref}\n\n`;
            textPreview += `Regards\nZoe Franks\nI & A Communications Ltd\nTel: 0845 200 4035`;
            generatedNoticeTextarea.value = textPreview;

            const numHouses = parseInt(noticeData.houses, 10);
            printCopiesDisplay.textContent = `Print ${isNaN(numHouses) || numHouses < 0 ? 0 : numHouses}`;
            showStep('step4');
        }

        /**
         * Triggers browser print and shows final step.
         */
        function printNotice() {
            postItDetails.innerHTML = `
                Location: ${noticeData.locationName || '[Exchange Missing]'}<br>
                Job Ref: ${noticeData.ref || '[Ref Missing]'}<br>
                Address: ${noticeData.fullAddress || '[Address Missing]'}
            `;
            window.print();
            showStep('step5');
        }

        /**
         * Resets the tool to its initial state.
         */
        function resetTool() {
            pasteArea.value = '';
            if(planFileInput) planFileInput.value = null;
            diversionRouteStep1Input.value = '';
            streetInput.value = '';
            townInput.value = '';
            workDaysInput.value = '2'; // DEFAULT TO 2
            affectedHousesInput.value = '';
            refNumberDisplay.value = '';
            dateDisplay.value = '';
            coordsDisplay.value = '';
            generatedNoticeTextarea.value = '';
            wbUpdatedCheckbox.checked = false;

            pasteError.textContent = ''; pasteSuccess.textContent = '';
            planError.textContent = ''; planSuccess.textContent = '';
            copyCoordsStatus.textContent = '';

            dataParsed = false; planUploaded = false;
            noticeData = { ref: '', lat: '', lon: '', date: '', street: '', town: '', days: '2', diversion: '', houses: '', postcode: '', locationName: '', fullAddress: '', columnCData: '' }; // DEFAULT DAYS TO 2
            if (planFileUrl) { URL.revokeObjectURL(planFileUrl); planFileUrl = null; }

            searchInstructionBox.style.display = 'none'; searchRefNumber.textContent = '[Job Number]';
            columnCBox.style.display = 'none'; columnCData.textContent = '[Data]';
            planPreview.innerHTML = '<p class="text-gray-500 text-sm">Plan preview will appear here.</p>';
            printCopiesDisplay.textContent = 'Print 0';
            postItDetails.innerHTML = 'Loading...';
            finaliseDropBtn.disabled = true;
            checkEnableStep1NextButton();
            showStep('step1');
            console.log("Tool reset. Default days set to 2.");
        }


        // --- Event Listeners ---
        parseAndNextBtn.addEventListener('click', parsePastedData);
        planFileInput.addEventListener('change', handlePlanUpload);
        copyCoordsBtn.addEventListener('click', copyCoordinatesToClipboard);
        viewPlanBtn.addEventListener('click', () => {
            if (planFileUrl) { window.open(planFileUrl, '_blank'); }
            else { alert("No plan file has been uploaded yet."); }
        });
        finaliseDropBtn.addEventListener('click', resetTool);
        wbUpdatedCheckbox.addEventListener('change', (event) => {
            finaliseDropBtn.disabled = !event.target.checked;
        });

        nextToStep3CombinedBtn.addEventListener('click', () => {
            noticeData.diversion = diversionRouteStep1Input.value.trim();
            if (!noticeData.diversion) {
                alert("Please enter the diversion route before proceeding.");
                diversionRouteStep1Input.focus(); return;
            }
            if (!dataParsed || !planUploaded) {
                alert("Please ensure data is parsed and a plan is uploaded successfully.");
                return;
            }

            updateMap();
            refNumberDisplay.value = noticeData.ref;
            dateDisplay.value = noticeData.date;
            coordsDisplay.value = (noticeData.lat && noticeData.lon) ? `${noticeData.lat}, ${noticeData.lon}` : 'N/A';
            workDaysInput.value = noticeData.days; // Populate workDaysInput with potentially updated days value

            showStep('step3');
            tryAutoFillMapSearch();
        });

        generateNoticeBtn.addEventListener('click', generateNotice);
        printNoticeBtn.addEventListener('click', printNotice);

        // --- Initialisation ---
        showStep('step1');

    </script>

</body>
</html>
