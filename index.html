<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTM Letter Drop Tool (Release 1.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Open+Sans:wght@400;700&family=Tinos:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/docx@7.3.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* Basic styling */
        body { font-family: 'Inter', sans-serif; }
        iframe { width: 100%; height: 100%; border: 1px solid #ccc; border-radius: 0.375rem; }

        /* Style for the plan preview area */
        #planPreview {
            border: 1px solid #ccc; border-radius: 0.375rem;
            display: flex; justify-content: center; align-items: center;
            overflow: auto; background-color: #f9fafb; padding: 0;
            text-align: center;
            width: 100%; max-width: 1000px; height: 600px;
            margin-left: auto; margin-right: auto;
        }
        #planPreview img { max-width: 100%; max-height: 100%; object-fit: contain; display: block; margin: auto; }
        #planPreview iframe { width: 100%; height: 100%; border: none; border-radius: 0.375rem; }

        /* Container for map iframe */
        .map-container {
            position: relative; width: 100%; max-width: 1000px; height: 600px;
            margin-left: auto; margin-right: auto;
            overflow: hidden; border: 1px solid #ccc; border-radius: 0.375rem;
        }
        .map-container iframe { width: 100%; height: 100%; border: none; }

        /* Style for button nested at bottom of map container */
        #copyCoordsBtn {
            position: absolute; bottom: 10px; left: 50%;
            transform: translateX(-50%); z-index: 10;
        }

        /* Hide steps initially */
        .step { display: none; }
        #step1 { display: block; }

        /* Add a subtle border between form groups in Step 1 */
        #step1 .form-group + .form-group {
            border-top: 1px solid #e5e7eb; padding-top: 1.5rem; margin-top: 1.5rem;
        }
        /* Add margin between instruction boxes */
        #searchInstructionBox + #columnCBox {
            margin-top: 1rem;
        }


        /* Grid for side-by-side layout and spacing */
        .map-plan-grid {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr)); /* Default to 1 column */
            gap: 1rem; /* Default gap */
        }
        @media (min-width: 768px) { /* md breakpoint */
            .map-plan-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 columns on medium screens and up */
            }
        }


        /* Styles for the printable notice area */
        #noticePrintArea {
            display: none; /* Hidden by default */
            font-family: 'Open Sans', sans-serif;
            color: black;
            width: 210mm; /* A4 width */
            padding: 15mm; /* Standard margins */
            box-sizing: border-box;
            background-color: white;
        }
        /* Font Substitutes & Sizes */
        #noticePrintArea .font-times { font-family: 'Tinos', serif; /* Google Font similar to Times */ }
        #noticePrintArea .print-text-10pt { font-size: 10pt; line-height: 1.1; }
        #noticePrintArea .print-text-11pt { font-size: 11pt; line-height: 1.25; }
        #noticePrintArea .print-text-12pt { font-size: 12pt; line-height: 1.25; }
        #noticePrintArea .print-text-22pt { font-size: 22pt; line-height: 1.2; }
        #noticePrintArea .print-text-24pt { font-size: 24pt; line-height: 1.2; }
        #noticePrintArea .font-bold { font-weight: 700; }
        #noticePrintArea .underline { text-decoration: underline; }
        #noticePrintArea .text-center { text-align: center; }
        #noticePrintArea .text-right { text-align: right; }
        /* Spacing Helpers */
        #noticePrintArea .mt-4 { margin-top: 4mm; }
        #noticePrintArea .mt-5 { margin-top: 5mm; }
        #noticePrintArea .mt-8 { margin-top: 8mm; }
        #noticePrintArea .mt-10 { margin-top: 10mm; }
        #noticePrintArea .mt-15 { margin-top: 15mm; }
        #noticePrintArea .mb-4 { margin-bottom: 4mm; }
        #noticePrintArea .mb-5 { margin-bottom: 5mm; }
        #noticePrintArea .mb-10 { margin-bottom: 10mm; }
        /* Float/Clear */
        #noticePrintArea .float-right { float: right; }
        #noticePrintArea .clear-both { clear: both; }
        /* Logo & Address Specific */
        #noticePrintArea .logo-container {
            width: 59.8mm; height: 11.4mm; float: right;
            margin-bottom: 5mm; text-align: right;
        }
         #noticePrintArea .logo-container img {
            max-width: 100%; max-height: 100%; display: inline-block;
         }
        #noticePrintArea .address-block {
            float: right; text-align: right; clear: right; margin-top: 5mm; width: 60mm;
        }
        #noticePrintArea p { margin-bottom: 5mm; } /* Default paragraph bottom margin for print */
        #noticePrintArea #print-closing p { margin-bottom: 1mm; margin-top: 1mm; } /* Specific for closing */
        /* Apply 1.25 line height specifically to body paragraphs */
        #noticePrintArea .body-para { line-height: 1.25 !important; }


        /* Print-specific styles */
        @media print {
            body * { visibility: hidden; }
            #noticePrintArea, #noticePrintArea * { visibility: visible; }
            #noticePrintArea {
                position: absolute; left: 0; top: 0;
                width: 100%; height: auto;
                padding: 15mm; margin: 0; border: none; box-shadow: none;
                display: block !important;
            }
            @page {
                margin: 0mm; size: A4 portrait;
            }
            body { margin: 0 !important; padding: 0 !important; }
        }

    </style>
</head>
<body class="bg-gray-100 p-4">

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 bg-white rounded-lg shadow-lg border border-gray-200" id="toolInterface">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">RTM Letter Drop Tool (Release 1.0)</h1>

        <div id="step1" class="step space-y-6">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Step 1: Data collection</h2>

            <div id="searchInstructionBox" class="p-4 rounded-md border-2 border-[#c31f33] text-gray-700 mb-6" style="display: none;">
                Search job number in folder: <strong id="searchRefNumber">[Job Number]</strong>
            </div>
            <div id="columnCBox" class="p-4 rounded-md border-2 border-[#c31f33] text-gray-700 bg-red-50" style="display: none;">
                Times: <strong id="columnCData">[Data]</strong>
            </div>

            <div class="form-group bg-blue-50 p-4 rounded-md border border-blue-200">
                <label for="pasteArea" class="block text-sm font-bold text-gray-700 mb-1">Copy and paste job row from planned WB</label>
                <p class="text-xs text-gray-600 mb-2">Date (Col A), Job Ref (Col H), Exchange (Col I), Full Address (Col P), Times (Col C).</p>
                <textarea id="pasteArea" placeholder="Paste row data here..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm font-mono min-h-[80px]"></textarea>
                <button id="parseAndNextBtn" class="mt-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">Save Job Details</button>
                <p id="pasteError" class="text-red-600 text-sm mt-2"></p>
                <p id="pasteSuccess" class="text-green-600 text-sm mt-2"></p>
            </div>

            <div class="form-group bg-green-50 p-4 rounded-md border border-green-200">
               <label for="planFile" class="block text-sm font-bold text-gray-700 mb-1">Upload TM Plan</label>
               <input type="file" id="planFile" accept="image/*,application/pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <p class="text-xs text-gray-600 mt-1">Accepts images or PDF. PDF viewing requires a browser viewer/extension.</p>
                <p id="planError" class="text-red-600 text-sm mt-2"></p>
                <p id="planSuccess" class="text-green-600 text-sm mt-2"></p>
           </div>

            <div class="form-group bg-yellow-50 p-4 rounded-md border border-yellow-200">
                <label for="diversionRouteStep1" class="block text-sm font-bold text-gray-700 mb-1">Enter diversion route</label>
                <textarea id="diversionRouteStep1" rows="3" placeholder="Enter diversion route details..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
            </div>

            <div class="mt-8 text-right">
                <button id="nextToStep3Combined" disabled class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">Next: Review Map & Plan</button>
            </div>
        </div>

        <div id="step3" class="step">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Step 2: Review Map/Plan & Enter Details</h2>

            <div class="map-plan-grid mb-6 mt-6">
                <div class="mb-4 md:mb-0 flex flex-col items-center">
                    <h3 class="text-lg font-medium text-gray-800 mb-2 w-full max-w-[1000px]">Map Location</h3>
                    <div class="map-container">
                        <iframe id="mapFrame" src="about:blank" title="Location Map"></iframe>
                        <button id="copyCoordsBtn" title="Copy coordinates to clipboard" class="py-2 px-4 text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:ring-indigo-500 shadow-md rounded-md">Copy Coordinates</button>
                    </div>
                    <p id="copyCoordsStatus" class="text-sm text-green-600 mt-2 h-4"></p>
                    <p id="mapSearchStatus" class="hidden"></p>
                </div>
                <div class="flex flex-col items-center">
                    <h3 class="text-lg font-medium text-gray-800 mb-2 w-full max-w-[1000px]">Uploaded Plan</h3>
                    <div id="planPreview">
                        <p class="text-gray-500 text-sm">Plan preview will appear here.</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                <div class="form-group">
                    <label for="streetInput" class="block text-sm font-medium text-gray-700 mb-1">Street:</label>
                    <input type="text" id="streetInput" placeholder="Enter street name from map" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="form-group">
                    <label for="townInput" class="block text-sm font-medium text-gray-700 mb-1">Town:</label>
                    <input type="text" id="townInput" placeholder="Enter town name from map" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="form-group">
                    <label for="workDays" class="block text-sm font-medium text-gray-700 mb-1">Number of Working Days:</label>
                    <input type="number" id="workDays" min="1" value="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="form-group">
                    <label for="affectedHouses" class="block text-sm font-medium text-gray-700 mb-1">Required Letters:</label>
                    <input type="number" id="affectedHouses" min="0" max="40" placeholder="e.g. 40" class="mt-1 block w-full px-3 py-2 bg-white border-2 border-[#c31f33] rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reference Number:</label>
                    <input type="text" id="refNumberDisplay" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date (adjusted):</label>
                    <input type="text" id="dateDisplay" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
                <div class="form-group md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Coordinates (extracted Lat, Lon):</label>
                    <input type="text" id="coordsDisplay" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                </div>
            </div>

            <div class="mt-8 flex justify-between">
                <button class="secondary-button inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="showStep('step1')">Back</button>
                <button id="generateNoticeBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Next: Generate Notice</button>
            </div>
        </div>

        <div id="step4" class="step">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Step 3: Generated Notice Text</h2>
            <p class="mb-4 mt-6 text-sm text-gray-600">Review the generated text below. Save to DOCX, then Print Notice.</p>
            <textarea id="generatedNotice" rows="20" readonly class="w-full p-3 border border-gray-300 rounded bg-gray-50 font-mono text-sm shadow-sm"></textarea>
            <div class="mt-6 flex justify-between items-center">
                <button class="secondary-button inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="showStep('step3')">Back</button>
                <div class="flex items-center space-x-3"> <div id="printCopiesDisplay" class="border-2 border-[#c31f33] rounded-md px-4 py-2 text-sm font-medium text-gray-700">
                        Print 0
                    </div>
                    <button id="saveDocxBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save docx</button>
                    <button id="printNoticeBtn" disabled class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed">Print Notice</button>
                </div>
            </div>
        </div>

        <div id="step5" class="step space-y-6">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Step 4: Final Actions</h2>

            <div class="bg-blue-50 p-4 rounded-md border border-blue-200">
                <h3 class="text-lg font-medium text-gray-800 mb-2">1. Print TM Plan</h3>
                <p class="text-sm text-gray-600 mb-3">Click the button below to open the uploaded TM plan in a new tab for printing.</p>
                <button id="viewPlanBtn" class="secondary-button inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">View/Print TM Plan</button>
            </div>

            <div class="bg-yellow-50 p-4 rounded-md border border-yellow-200">
                <h3 class="text-lg font-medium text-gray-800 mb-2">2. Prepare Post-it Note</h3>
                <p class="text-sm text-gray-600 mb-3">Write the following details on a post-it note:</p>
                <div id="postItDetails" class="p-3 bg-white border border-gray-200 rounded-md text-sm font-mono">
                    Loading...
                </div>
            </div>

            <div class="bg-purple-50 p-4 rounded-md border border-purple-200">
                <h3 class="text-lg font-medium text-gray-800 mb-2">3. Update Spreadsheet</h3>
                <p class="text-sm text-gray-600">Remember to update your main tracking spreadsheet with the relevant details for this notice.</p>
                <div class="mt-4 flex items-center">
                    <input id="wbUpdatedCheckbox" name="wbUpdatedCheckbox" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="wbUpdatedCheckbox" class="ml-2 block text-sm text-gray-900"> I have updated the WB </label>
                </div>
            </div>

            <div class="mt-8 flex justify-between items-center">
                <button class="secondary-button inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="showStep('step4')">Back</button>
                <button id="finaliseDropBtn" disabled class="inline-flex justify-center py-2 px-6 border-2 border-green-500 shadow-sm text-base font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed">New Notice</button>
            </div>
        </div>

    </div> <div id="noticePrintArea">
        <div class="logo-container">
            <img id="print-logo-img" src="https://raw.githubusercontent.com/RTMOffice/notice-tool/refs/heads/main/Logo.jpg" alt="Company Logo">
        </div>
        <div class="address-block print-text-10pt">
            <div>I & A Communications</div>
            <div>Burgon House</div>
            <div>James Swallow Way</div>
            <div>London and Medway Commercial</div>
            <div>Rochester</div>
            <div>Kent</div>
            <div>ME3 9GX</div>
            <div class="mt-4">Tel:      0845 200 4035</div>
        </div>
        <div class="clear-both mb-10"></div>
        <div class="mt-15 font-times print-text-22pt font-bold" id="print-please-note">PLEASE NOTE</div>
        <div class="mt-4 print-text-24pt underline text-center" id="print-date">On DATE</div>
        <p class="mt-10 print-text-11pt body-para" id="print-para1">
            I&A Communications working on behalf of BT Openreach are responsible for maintaining the network that provides you with your communications service regardless of which telephony or broadband supplier you are using and have been tasked in replacing a BT pole along <strong class="font-bold" id="print-para1-street-town">STREET, TOWN</strong>.
        </p>
        <p class="print-text-11pt body-para" id="print-para2">
            The work is expected to take a maximum of <strong class="font-bold" id="print-para2-days">DAY working days</strong> and during this time there will be a road closure in place. Access will be maintained for residents, but we ask for your patience while our engineers make way as this can take some time, alternatively you can follow our diversion <strong class="font-bold" id="print-para2-div">DIV</strong> and Vice Versa.
        </p>
        <p class="print-text-11pt body-para" id="print-para3">
            <strong class="font-bold" id="print-para3-street-town">STREET, TOWN</strong> will be closed during the hours of 09:00am and 17:00pm, the road will be reopened outside these times.
        </p>
        <p class="print-text-11pt font-bold body-para" id="print-apology">
            We would like to apologise if this work causes any inconvenience and would also like to thank you in advance for your co-operation.
        </p>
        <p class="print-text-12pt body-para" id="print-concerns">
            ANY CONCERNS PLEASE CALL <strong class="font-bold" id="print-concerns-phone">0845 200 4035</strong> WITH OUR REF: <span id="print-concerns-ref">REFR</span>
        </p>
        <div class="mt-10 print-text-11pt body-para" id="print-closing">
            <p>Regards</p>
            <p class="mt-4">Zoe Franks</p>
            <p>I & A Communications Ltd</p>
            <p>Tel: 0845 200 4035</p>
        </div>
    </div>


    <script>
        // --- Global Variables ---
        let planFileUrl = null;
        let noticeData = {
            ref: '', lat: '', lon: '', date: '', street: '', town: '',
            days: '2', diversion: '', houses: '', postcode: '',
            locationName: '', fullAddress: '', columnCData: ''
        };
        let dataParsed = false;
        let planUploaded = false;

        // --- DOM Elements ---
        const steps = document.querySelectorAll('.step');
        const pasteArea = document.getElementById('pasteArea');
        const pasteError = document.getElementById('pasteError');
        const pasteSuccess = document.getElementById('pasteSuccess');
        const planFileInput = document.getElementById('planFile');
        const planPreview = document.getElementById('planPreview');
        const planError = document.getElementById('planError');
        const planSuccess = document.getElementById('planSuccess');
        const diversionRouteStep1Input = document.getElementById('diversionRouteStep1');
        const mapFrame = document.getElementById('mapFrame');
        const streetInput = document.getElementById('streetInput');
        const townInput = document.getElementById('townInput');
        const workDaysInput = document.getElementById('workDays');
        const affectedHousesInput = document.getElementById('affectedHouses');
        const refNumberDisplay = document.getElementById('refNumberDisplay');
        const dateDisplay = document.getElementById('dateDisplay');
        const coordsDisplay = document.getElementById('coordsDisplay');
        const copyCoordsBtn = document.getElementById('copyCoordsBtn');
        const copyCoordsStatus = document.getElementById('copyCoordsStatus');
        const generatedNoticeTextarea = document.getElementById('generatedNotice');
        const printCopiesDisplay = document.getElementById('printCopiesDisplay');
        const searchInstructionBox = document.getElementById('searchInstructionBox');
        const searchRefNumber = document.getElementById('searchRefNumber');
        const columnCBox = document.getElementById('columnCBox');
        const columnCData = document.getElementById('columnCData');
        // Step 3 Buttons
        const saveDocxBtn = document.getElementById('saveDocxBtn');
        const printNoticeBtn = document.getElementById('printNoticeBtn');
        // Step 4 Elements
        const postItDetails = document.getElementById('postItDetails');
        const viewPlanBtn = document.getElementById('viewPlanBtn');
        const finaliseDropBtn = document.getElementById('finaliseDropBtn');
        const wbUpdatedCheckbox = document.getElementById('wbUpdatedCheckbox');

        // Navigation Buttons
        const parseAndNextBtn = document.getElementById('parseAndNextBtn');
        const nextToStep3CombinedBtn = document.getElementById('nextToStep3Combined');
        const generateNoticeBtn = document.getElementById('generateNoticeBtn');

        // --- Functions ---

        function showStep(stepId) {
            steps.forEach(step => {
                step.style.display = (step.id === stepId) ? 'block' : 'none';
            });
            window.scrollTo(0, 0);
            if (stepId !== 'step5' && wbUpdatedCheckbox) {
                wbUpdatedCheckbox.checked = false;
                finaliseDropBtn.disabled = true;
            }
            if (stepId !== 'step4') { // When leaving step 3 (id=step4)
                printNoticeBtn.disabled = true; // Ensure print button is disabled
            }
        }

        function checkEnableStep1NextButton() {
            nextToStep3CombinedBtn.disabled = !(dataParsed && planUploaded);
        }

        function getDaySuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return "st"; case 2: return "nd"; case 3: return "rd"; default: return "th";
            }
        }

        function parsePastedData() {
            pasteError.textContent = ''; pasteSuccess.textContent = '';
            dataParsed = false; noticeData.days = '2';
            searchInstructionBox.style.display = 'none'; columnCBox.style.display = 'none';
            checkEnableStep1NextButton();

            const pastedText = pasteArea.value.trim();
            if (!pastedText) { pasteError.textContent = 'Please paste data.'; return; }
            const columns = pastedText.split('\t');
            if (columns.length <= 15) { pasteError.textContent = `Error: Need at least 16 columns (found ${columns.length}).`; return; }

            try {
                let rawDateStr = columns[0]?.trim();
                if (!rawDateStr) throw new Error("Date (Col A) missing.");
                let parsedDate;
                let tempDate = new Date(rawDateStr);
                if (!isNaN(tempDate.getTime())) { parsedDate = tempDate; }
                else {
                    const dateParts = rawDateStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
                    if (dateParts) {
                        const day = parseInt(dateParts[1],10), month = parseInt(dateParts[2],10)-1;
                        let year = parseInt(dateParts[3],10); if(year < 100) year+=2000;
                        parsedDate = new Date(Date.UTC(year, month, day));
                        if(isNaN(parsedDate.getTime())) throw new Error(`Invalid date: "${rawDateStr}".`);
                    } else {
                        const serial = Number(rawDateStr);
                        if (!isNaN(serial) && serial > 1 && serial < 2958466) {
                            parsedDate = new Date((serial - 25569) * 86400 * 1000);
                            if(isNaN(parsedDate.getTime())) throw new Error(`Invalid serial date: "${rawDateStr}".`);
                        } else throw new Error(`Unrecognized date: "${rawDateStr}".`);
                    }
                }
                const today = new Date(), currentYear = today.getUTCFullYear();
                const compDate = new Date(Date.UTC(currentYear, parsedDate.getUTCMonth(), parsedDate.getUTCDate()));
                const todayOnly = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
                parsedDate.setUTCFullYear(compDate < todayOnly ? currentYear + 1 : currentYear);
                noticeData.date = `${parsedDate.toLocaleDateString('en-GB', {weekday:'long', timeZone:'UTC'}).toUpperCase()} ${parsedDate.getUTCDate() + getDaySuffix(parsedDate.getUTCDate())} ${parsedDate.toLocaleDateString('en-GB', {month:'long', timeZone:'UTC'}).toUpperCase()} ${parsedDate.getUTCFullYear()}`;

                noticeData.ref = columns[7]?.trim(); if (!noticeData.ref) throw new Error("Ref (Col H) missing.");
                noticeData.locationName = columns[8]?.trim(); if (!noticeData.locationName) throw new Error("Exchange (Col I) missing.");
                let locStr = columns[15]?.trim(); if (!locStr) throw new Error("Location (Col P) missing.");
                noticeData.fullAddress = locStr;
                const coordMatch = locStr.match(/.*?(-?\d{1,3}(?:\.\d+)?)\s*,\s*(-?\d{1,3}(?:\.\d+)?)/);
                if (coordMatch) {
                    const lat = parseFloat(coordMatch[1]), lon = parseFloat(coordMatch[2]);
                    if (lat>=-90&&lat<=90&&lon>=-180&&lon<=180) { noticeData.lat=String(lat); noticeData.lon=String(lon); }
                    else throw new Error(`Coords out of range: ${lat}, ${lon}.`);
                } else throw new Error("Lat, Lon not found in Col P.");

                noticeData.columnCData = columns[2]?.trim() || "";
                if (noticeData.columnCData) {
                    const daysMatch = noticeData.columnCData.match(/\b(\d+)\s*day(s)?\b/i);
                    if (daysMatch && daysMatch[1]) {
                        const extractedDays = parseInt(daysMatch[1], 10);
                        if (extractedDays > 0) noticeData.days = String(extractedDays);
                    }
                    columnCData.textContent = noticeData.columnCData; columnCBox.style.display = 'block';
                } else { columnCBox.style.display = 'none'; }

                pasteSuccess.textContent = 'Data parsed successfully!'; dataParsed = true;
                searchRefNumber.textContent = noticeData.ref; searchInstructionBox.style.display = 'block';
                checkEnableStep1NextButton();
            } catch (error) {
                console.error("Parsing error:", error); pasteError.textContent = `Error: ${error.message}`;
                dataParsed = false; searchInstructionBox.style.display = 'none'; columnCBox.style.display = 'none';
                checkEnableStep1NextButton();
                noticeData = { ref: '', lat: '', lon: '', date: '', street: '', town: '', days: '2', diversion: '', houses: '', postcode: '', locationName: '', fullAddress: '', columnCData: '' };
            }
        }

        function handlePlanUpload(event) {
            const file = event.target.files[0];
            planError.textContent = ''; planSuccess.textContent = ''; planUploaded = false;
            checkEnableStep1NextButton();
            planPreview.innerHTML = '<p class="text-gray-500 text-sm">Processing plan...</p>';
            if (planFileUrl) { URL.revokeObjectURL(planFileUrl); planFileUrl = null; }
            if (!file) { planPreview.innerHTML = '<p class="text-gray-500 text-sm">No plan selected.</p>'; return; }

            try { planFileUrl = URL.createObjectURL(file); }
            catch (e) {
                planError.textContent = 'Could not create URL for file.';
                planPreview.innerHTML = '<p class="text-red-500 text-sm">Error loading preview.</p>';
                planUploaded = false; checkEnableStep1NextButton(); return;
            }

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img'); img.src = planFileUrl; img.alt = "Plan Preview";
                img.onerror = () => {
                    planError.textContent='Could not display image.'; planPreview.innerHTML='<p class="text-red-500 text-sm">Error image preview.</p>';
                    URL.revokeObjectURL(planFileUrl); planFileUrl=null; planUploaded=false; checkEnableStep1NextButton();
                };
                img.onload = () => {
                    planPreview.innerHTML=''; planPreview.appendChild(img); planSuccess.textContent=`Image "${file.name}" uploaded.`;
                    planUploaded=true; checkEnableStep1NextButton();
                };
            } else if (file.type === 'application/pdf') {
                planPreview.innerHTML=''; const iframe = document.createElement('iframe');
                iframe.src = planFileUrl; iframe.title="Plan PDF Preview"; iframe.type="application/pdf";
                iframe.onload = () => { planSuccess.textContent=`PDF "${file.name}" uploaded.`; planUploaded=true; checkEnableStep1NextButton(); };
                iframe.onerror = () => {
                    planError.textContent='Could not load PDF.'; planPreview.innerHTML='<p class="text-red-500 text-sm">Error PDF preview.</p>';
                    URL.revokeObjectURL(planFileUrl); planFileUrl=null; planUploaded=false; checkEnableStep1NextButton();
                };
                planPreview.appendChild(iframe);
            } else {
                planError.textContent='Unsupported file (Image/PDF only).'; planPreview.innerHTML='<p class="text-red-500 text-sm">Invalid file.</p>';
                URL.revokeObjectURL(planFileUrl); planFileUrl=null; planUploaded=false; checkEnableStep1NextButton();
            }
        }

        function updateMap() {
            if (noticeData.lat && noticeData.lon) {
                mapFrame.src = `https://symology.maps.arcgis.com/apps/webappviewer/index.html?id=1055c1d3a2c344cea5353d8ed744831c&center=${noticeData.lon},${noticeData.lat}&level=15`;
            } else { mapFrame.src = 'about:blank'; }
        }

        function tryAutoFillMapSearch() {
            const coordsStr = coordsDisplay.value; if (!coordsStr || coordsStr === 'N/A') return;
            setTimeout(() => {
                try {
                    const iDoc = mapFrame.contentWindow?.document; if (!iDoc) return;
                    const searchIn = iDoc.getElementById('esri_dijit_Search_0_input');
                    if (searchIn) searchIn.value = coordsStr;
                } catch (e) { console.warn("ArcGIS Auto-fill failed:", e.message); }
            }, 3000);
        }

        function copyCoordinatesToClipboard() {
            const coordsStr = coordsDisplay.value; copyCoordsStatus.textContent = '';
            if (!coordsStr || coordsStr === 'N/A') { copyCoordsStatus.textContent = 'No coords to copy.'; return; }
            if (!navigator.clipboard) { copyCoordsStatus.textContent = 'Clipboard unavailable.'; return; }
            navigator.clipboard.writeText(coordsStr).then(() => {
                copyCoordsStatus.textContent = 'Coords copied!'; setTimeout(() => copyCoordsStatus.textContent = '', 3000);
            }).catch(err => copyCoordsStatus.textContent = 'Copy failed.');
        }

        function generateNotice() {
            noticeData.street = streetInput.value.trim(); noticeData.town = townInput.value.trim();
            if (!noticeData.street) { alert("Enter Street."); streetInput.focus(); return; }
            if (!noticeData.town) { alert("Enter Town."); townInput.focus(); return; }
            const streetAndTown = `${noticeData.street}, ${noticeData.town}`;

            noticeData.days = workDaysInput.value || '2'; noticeData.houses = affectedHousesInput.value || '0';
            if (!noticeData.diversion) { alert("Diversion route missing (Step 1)."); showStep('step1'); diversionRouteStep1Input.focus(); return; }

            const daysText = `${noticeData.days} working day${parseInt(noticeData.days) === 1 ? '' : 's'}`;
            document.getElementById('print-date').textContent = `On ${noticeData.date}`;
            document.getElementById('print-para1-street-town').textContent = streetAndTown;
            document.getElementById('print-para2-days').textContent = daysText;
            document.getElementById('print-para2-div').textContent = noticeData.diversion;
            document.getElementById('print-para3-street-town').textContent = streetAndTown;
            document.getElementById('print-concerns-ref').textContent = noticeData.ref;

            let textPreview = `I & A Communications Ltd\n\nTel: 0845 200 4035\n\nPLEASE NOTE\nOn ${noticeData.date}\n\n`;
            textPreview += `I&A Communications working on behalf of BT Openreach are responsible for maintaining the network that provides you with your communications service regardless of which telephony or broadband supplier you are using and have been tasked in replacing a BT pole along ${streetAndTown}.\n\n`;
            textPreview += `The work is expected to take a maximum of ${daysText} and during this time there will be a road closure in place. Access will be maintained for residents, but we ask for your patience while our engineers make way as this can take some time, alternatively you can follow our diversion ${noticeData.diversion} and Vice Versa.\n\n`;
            textPreview += `${streetAndTown} will be closed during the hours of 09:00am and 17:00pm, the road will be reopened outside these times.\n\n`;
            textPreview += `We would like to apologise if this work causes any inconvenience and would also like to thank you in advance for your co-operation.\n\n`;
            textPreview += `ANY CONCERNS PLEASE CALL 0845 200 4035 WITH OUR REF: ${noticeData.ref}\n\n`;
            textPreview += `Regards\nZoe Franks\nI & A Communications Ltd\nTel: 0845 200 4035`;
            generatedNoticeTextarea.value = textPreview;

            const numHouses = parseInt(noticeData.houses, 10);
            printCopiesDisplay.textContent = `Print ${isNaN(numHouses)||numHouses<0 ? 0 : numHouses}`;
            printNoticeBtn.disabled = true; // Disable print button until DOCX is saved
            showStep('step4');
        }

        function createDocxContent() {
            const { Document, Packer, Paragraph, TextRun, AlignmentType } = docx; // Removed UnderlineType as it's not directly used for simple underline

            const children = [];

            // Address Block (Right Aligned, 10pt Open Sans)
            const addressLines = [
                "I & A Communications", "Burgon House", "James Swallow Way",
                "London and Medway Commercial", "Rochester", "Kent", "ME3 9GX",
                "Tel:      0845 200 4035"
            ];
            addressLines.forEach((line, index) => {
                children.push(new Paragraph({
                    alignment: AlignmentType.RIGHT,
                    spacing: { after: (index === addressLines.length - 2) ? 80 : (index === addressLines.length - 1 ? 0 : 40) }, // Spacing adjustments
                    children: [new TextRun({ text: line, font: "Open Sans", size: 20 })] // 10pt = 20 half-points
                }));
            });
            children.push(new Paragraph({ spacing: { after: 200 } })); // Equivalent to mb-10

            // PLEASE NOTE (22pt, Bold, Tinos - or fallback Open Sans if Tinos not well supported in docx lib)
            children.push(new Paragraph({
                spacing: { before: 1700, after: 80 }, // mt-15 then mt-4
                children: [new TextRun({ text: "PLEASE NOTE", font: "Tinos", size: 44, bold: true })]
            }));

            // On DATE (24pt, Underline, Center, Open Sans)
            children.push(new Paragraph({
                alignment: AlignmentType.CENTER,
                spacing: { after: 1130 }, // mt-10
                children: [new TextRun({ text: `On ${noticeData.date}`, font: "Open Sans", size: 48, underline: {} })]
            }));

            // Common style for body paragraphs (11pt Open Sans, approx 1.25 line height)
            // docx.js line spacing is complex; using `line` property with a value like 360 (for 1.5 lines) or 240 (single)
            // For 1.25, it's often trial and error or leaving it to Word's default.
            // We'll set font size and let Word handle line height or use a simple multiplier if available.
            // The `line` property expects units of 1/20th of a point. 11pt * 1.25 line height.
            // A simple approach is to just set font size and let Word default line spacing.
            // For more control: `line: 11 * 20 * 1.25 = 275` (approx for 1.25 lines)
            const paraStyle = { font: "Open Sans", size: 22 }; // 11pt
            const paraSpacing = { after: 280 }; // mb-5

            // Para 1
            children.push(new Paragraph({
                spacing: paraSpacing,
                children: [
                    new TextRun({ ...paraStyle, text: "I&A Communications working on behalf of BT Openreach are responsible for maintaining the network that provides you with your communications service regardless of which telephony or broadband supplier you are using and have been tasked in replacing a BT pole along " }),
                    new TextRun({ ...paraStyle, text: `${noticeData.street}, ${noticeData.town}`, bold: true }),
                    new TextRun({ ...paraStyle, text: "." })
                ]
            }));

            // Para 2
            const daysTextDocx = `${noticeData.days} working day${parseInt(noticeData.days) === 1 ? '' : 's'}`;
            children.push(new Paragraph({
                spacing: paraSpacing,
                children: [
                    new TextRun({ ...paraStyle, text: `The work is expected to take a maximum of ` }),
                    new TextRun({ ...paraStyle, text: daysTextDocx, bold: true }),
                    new TextRun({ ...paraStyle, text: " and during this time there will be a road closure in place. Access will be maintained for residents, but we ask for your patience while our engineers make way as this can take some time, alternatively you can follow our diversion " }),
                    new TextRun({ ...paraStyle, text: noticeData.diversion, bold: true }),
                    new TextRun({ ...paraStyle, text: " and Vice Versa." })
                ]
            }));

            // Para 3
            children.push(new Paragraph({
                spacing: paraSpacing,
                children: [
                    new TextRun({ ...paraStyle, text: `${noticeData.street}, ${noticeData.town}`, bold: true }),
                    new TextRun({ ...paraStyle, text: " will be closed during the hours of 09:00am and 17:00pm, the road will be reopened outside these times." })
                ]
            }));

            // Apology
            children.push(new Paragraph({
                spacing: paraSpacing,
                children: [new TextRun({ ...paraStyle, text: "We would like to apologise if this work causes any inconvenience and would also like to thank you in advance for your co-operation.", bold: true })]
            }));

            // Concerns (12pt Open Sans)
            children.push(new Paragraph({
                spacing: { after: 1130 }, // mt-10
                children: [
                    new TextRun({ text: "ANY CONCERNS PLEASE CALL ", font: "Open Sans", size: 24 }), // 12pt
                    new TextRun({ text: "0845 200 4035", font: "Open Sans", size: 24, bold: true }),
                    new TextRun({ text: " WITH OUR REF: ", font: "Open Sans", size: 24 }),
                    new TextRun({ text: noticeData.ref, font: "Open Sans", size: 24 })
                ]
            }));

            // Closing (11pt Open Sans)
            const closingLines = ["Regards", "Zoe Franks", "I & A Communications Ltd", "Tel: 0845 200 4035"];
            closingLines.forEach((line, index) => {
                children.push(new Paragraph({
                    spacing: { after: index === 0 ? 80 : 20 }, // mt-4 after Regards, then 1mm
                    children: [new TextRun({ text: line, font: "Open Sans", size: 22 })] // 11pt
                }));
            });

            return new Document({
                sections: [{
                    properties: {
                        page: {
                            margin: { // A4 Page size, 15mm margins
                                top: docx.convertMillimetersToTwip(15), right: docx.convertMillimetersToTwip(15),
                                bottom: docx.convertMillimetersToTwip(15), left: docx.convertMillimetersToTwip(15),
                            },
                        },
                    },
                    children: children
                }]
            });
        }


        function saveDocumentToFile(doc, filename) {
            const { Packer } = docx;
            Packer.toBlob(doc).then(blob => {
                saveAs(blob, filename); // saveAs is from FileSaver.js
                console.log(`Document "${filename}" created successfully`);
                printNoticeBtn.disabled = false; // Enable print button after DOCX is saved
            }).catch(err => {
                console.error("Error creating document blob:", err);
                alert("Error creating DOCX file. Please try again.");
            });
        }


        function printNotice() {
            let awsDetailsLine = "";
            if (noticeData.columnCData && noticeData.columnCData.includes("AWS ")) {
                const awsStartIndex = noticeData.columnCData.indexOf("AWS ");
                let awsValue = noticeData.columnCData.substring(awsStartIndex + 4);
                const delimiterIndex = awsValue.indexOf(" // ");
                if (delimiterIndex !== -1) {
                    awsValue = awsValue.substring(0, delimiterIndex).trim();
                } else {
                    awsValue = awsValue.trim();
                }
                if (awsValue) { awsDetailsLine = `AWS ${awsValue}<br>`; }
            }
            postItDetails.innerHTML = `
                ${awsDetailsLine}Location: ${noticeData.locationName || '[Exchange Missing]'}<br>
                Job Ref: ${noticeData.ref || '[Ref Missing]'}<br>
                Address: ${noticeData.fullAddress || '[Address Missing]'}
            `;
            window.print();
            showStep('step5');
        }

        function resetTool() {
            pasteArea.value = ''; if(planFileInput) planFileInput.value = null;
            diversionRouteStep1Input.value = ''; streetInput.value = ''; townInput.value = '';
            workDaysInput.value = '2'; affectedHousesInput.value = '';
            refNumberDisplay.value = ''; dateDisplay.value = ''; coordsDisplay.value = '';
            generatedNoticeTextarea.value = ''; wbUpdatedCheckbox.checked = false;
            pasteError.textContent = ''; pasteSuccess.textContent = ''; planError.textContent = '';
            planSuccess.textContent = ''; copyCoordsStatus.textContent = '';
            dataParsed = false; planUploaded = false;
            noticeData = { ref: '', lat: '', lon: '', date: '', street: '', town: '', days: '2', diversion: '', houses: '', postcode: '', locationName: '', fullAddress: '', columnCData: '' };
            if (planFileUrl) { URL.revokeObjectURL(planFileUrl); planFileUrl = null; }
            searchInstructionBox.style.display = 'none'; searchRefNumber.textContent = '[Job Number]';
            columnCBox.style.display = 'none'; columnCData.textContent = '[Data]';
            planPreview.innerHTML = '<p class="text-gray-500 text-sm">Plan preview will appear here.</p>';
            printCopiesDisplay.textContent = 'Print 0'; postItDetails.innerHTML = 'Loading...';
            finaliseDropBtn.disabled = true;
            printNoticeBtn.disabled = true; // Ensure print button is disabled on reset
            checkEnableStep1NextButton(); showStep('step1');
        }

        // --- Event Listeners ---
        parseAndNextBtn.addEventListener('click', parsePastedData);
        planFileInput.addEventListener('change', handlePlanUpload);
        copyCoordsBtn.addEventListener('click', copyCoordinatesToClipboard);
        viewPlanBtn.addEventListener('click', () => {
            if (planFileUrl) { window.open(planFileUrl, '_blank'); }
            else { alert("No plan file uploaded."); }
        });
        finaliseDropBtn.addEventListener('click', resetTool);
        wbUpdatedCheckbox.addEventListener('change', (e) => { finaliseDropBtn.disabled = !e.target.checked; });

        nextToStep3CombinedBtn.addEventListener('click', () => {
            noticeData.diversion = diversionRouteStep1Input.value.trim();
            if (!noticeData.diversion) { alert("Enter diversion route."); diversionRouteStep1Input.focus(); return; }
            if (!dataParsed || !planUploaded) { alert("Parse data & upload plan first."); return; }
            updateMap();
            refNumberDisplay.value = noticeData.ref; dateDisplay.value = noticeData.date;
            coordsDisplay.value = (noticeData.lat && noticeData.lon) ? `${noticeData.lat}, ${noticeData.lon}` : 'N/A';
            workDaysInput.value = noticeData.days;
            showStep('step3'); tryAutoFillMapSearch();
        });

        generateNoticeBtn.addEventListener('click', generateNotice);

        saveDocxBtn.addEventListener('click', () => {
            try {
                const doc = createDocxContent();
                const filename = `Letter Drop ${noticeData.ref || 'UnknownRef'}.docx`; // Use ref for filename
                saveDocumentToFile(doc, filename);
            } catch (e) {
                console.error("Error generating DOCX:", e);
                alert("Could not generate DOCX file. Check console for details.");
            }
        });

        printNoticeBtn.addEventListener('click', printNotice);

        // --- Initialisation ---
        showStep('step1');
    </script>
</body>
</html>
