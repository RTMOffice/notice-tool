<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notice Generation Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Open+Sans:wght@400;700&family=Tinos:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Basic styling */
        body { font-family: 'Inter', sans-serif; }
        iframe { width: 100%; height: 100%; border: 1px solid #ccc; border-radius: 0.375rem; }

        /* Style for the plan preview area */
        #planPreview {
             border: 1px solid #ccc; border-radius: 0.375rem;
             display: flex; justify-content: center; align-items: center;
             overflow: auto; background-color: #f9fafb; padding: 0;
             text-align: center;
             width: 100%; max-width: 1000px; height: 600px;
             margin-left: auto; margin-right: auto;
        }
        #planPreview img { max-width: 100%; max-height: 100%; object-fit: contain; display: block; margin: auto; }
        #planPreview iframe { width: 100%; height: 100%; border: none; border-radius: 0.375rem; }

        /* Container for map iframe */
        .map-container {
            position: relative; width: 100%; max-width: 1000px; height: 600px;
             margin-left: auto; margin-right: auto;
             overflow: hidden; border: 1px solid #ccc; border-radius: 0.375rem;
        }
        .map-container iframe { width: 100%; height: 100%; border: none; }

        /* Style for button nested at bottom of map container */
        #copyCoordsBtn {
            position: absolute; bottom: 10px; left: 50%;
            transform: translateX(-50%); z-index: 10;
        }

        /* Hide steps initially */
        .step { display: none; }
        #step1 { display: block; }

        /* Add a subtle border between form groups in Step 1 */
        #step1 .form-group + .form-group {
            border-top: 1px solid #e5e7eb; padding-top: 1.5rem; margin-top: 1.5rem;
        }

        /* Grid for side-by-side layout and spacing */
        .map-plan-grid {
             display: grid;
             grid-template-columns: repeat(1, minmax(0, 1fr)); /* Default to 1 column */
             gap: 1rem; /* Default gap */
        }
        @media (min-width: 768px) { /* md breakpoint */
             .map-plan-grid {
                 grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 columns on medium screens and up */
             }
        }


        /* Styles for the printable notice area */
        #noticePrintArea {
            display: none; /* Hidden by default */
            font-family: 'Open Sans', sans-serif; /* USE OPEN SANS */
            color: black;
            width: 210mm; /* A4 width */
            padding: 15mm; /* Standard margins */
            box-sizing: border-box;
            background-color: white;
        }
        /* Font Substitutes & Sizes */
        #noticePrintArea .font-times { font-family: 'Tinos', serif; /* Google Font similar to Times */ }
        #noticePrintArea .print-text-10pt { font-size: 10pt; line-height: 1.1; }
        #noticePrintArea .print-text-11pt { font-size: 11pt; line-height: 1.1; }
        #noticePrintArea .print-text-12pt { font-size: 12pt; line-height: 1.1; }
        #noticePrintArea .print-text-22pt { font-size: 22pt; line-height: 1.2; }
        #noticePrintArea .print-text-24pt { font-size: 24pt; line-height: 1.2; }
        #noticePrintArea .font-bold { font-weight: 700; }
        #noticePrintArea .underline { text-decoration: underline; }
        #noticePrintArea .text-center { text-align: center; }
        #noticePrintArea .text-right { text-align: right; }
        /* Spacing Helpers */
        #noticePrintArea .mt-4 { margin-top: 4mm; }
        #noticePrintArea .mt-5 { margin-top: 5mm; }
        #noticePrintArea .mt-8 { margin-top: 8mm; }
        #noticePrintArea .mt-10 { margin-top: 10mm; }
        #noticePrintArea .mt-15 { margin-top: 15mm; }
        #noticePrintArea .mb-4 { margin-bottom: 4mm; }
        #noticePrintArea .mb-5 { margin-bottom: 5mm; }
        #noticePrintArea .mb-10 { margin-bottom: 10mm; }
        /* Float/Clear */
        #noticePrintArea .float-right { float: right; }
        #noticePrintArea .clear-both { clear: both; }
        /* Logo & Address Specific */
        #noticePrintArea .logo-container {
            width: 59.8mm; height: 11.4mm; float: right;
            margin-bottom: 5mm; text-align: right;
        }
         #noticePrintArea .logo-container img {
             max-width: 100%; max-height: 100%; display: inline-block;
         }
        #noticePrintArea .address-block {
             float: right; text-align: right; clear: right; margin-top: 5mm; width: 60mm;
        }
         #noticePrintArea p { margin-bottom: 5mm; }
         #noticePrintArea #print-closing p { margin-bottom: 1mm; margin-top: 1mm; }


        /* Print-specific styles */
        @media print {
            body * { visibility: hidden; }
            #noticePrintArea, #noticePrintArea * { visibility: visible; }
            #noticePrintArea {
                position: absolute; left: 0; top: 0;
                width: 100%; height: auto;
                padding: 15mm; margin: 0; border: none; box-shadow: none;
                display: block !important;
            }
             @page {
                margin: 0mm; size: A4 portrait;
            }
             body { margin: 0 !important; padding: 0 !important; }
        }

    </style>
</head>
<body class="bg-gray-100 p-4">

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 bg-white rounded-lg shadow-lg border border-gray-200" id="toolInterface">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Notice Generation Tool (Ver 54)</h1>

        <div id="step1" class="step space-y-6">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Step 1: Data collection</h2>

            <div class="form-group bg-blue-50 p-4 rounded-md border border-blue-200">
                <label for="pasteArea" class="block text-sm font-bold text-gray-700 mb-1">Copy and paste job row from planned WB</label>
                <p class="text-xs text-gray-600 mb-2">Date (Col A), Job (Col H), Location (Col P).</p>
                <textarea id="pasteArea" placeholder="Paste row data here..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm font-mono min-h-[80px]"></textarea>
                <button id="parseAndNextBtn" class="mt-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">Parse Pasted Data</button>
                <p id="pasteError" class="text-red-600 text-sm mt-2"></p>
                <p id="pasteSuccess" class="text-green-600 text-sm mt-2"></p>
            </div>

             <div class="form-group bg-green-50 p-4 rounded-md border border-green-200">
               <label for="planFile" class="block text-sm font-bold text-gray-700 mb-1">Upload TM Plan</label>
               <input type="file" id="planFile" accept="image/*,application/pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <p class="text-xs text-gray-600 mt-1">Accepts images or PDF. PDF viewing requires a browser viewer/extension.</p>
                <p id="planError" class="text-red-600 text-sm mt-2"></p>
                <p id="planSuccess" class="text-green-600 text-sm mt-2"></p>
           </div>

            <div class="form-group bg-yellow-50 p-4 rounded-md border border-yellow-200">
                <label for="diversionRouteStep1" class="block text-sm font-bold text-gray-700 mb-1">Enter diversion route</label>
                <textarea id="diversionRouteStep1" rows="3" placeholder="Enter diversion route details..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
            </div>

             <div class="mt-8 text-right">
                 <button id="nextToStep3Combined" disabled class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">Next: Review Map & Plan</button>
             </div>
        </div>

        <div id="step3" class="step">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Step 2: Review Map/Plan & Enter Details</h2>

            <div class="map-plan-grid mb-6 mt-6"> <div class="mb-4 md:mb-0 flex flex-col items-center"> <h3 class="text-lg font-medium text-gray-800 mb-2 w-full max-w-[1000px]">Map Location</h3>
                    <div class="map-container">
                        <iframe id="mapFrame" src="about:blank" title="Location Map"></iframe>
                        <button id="copyCoordsBtn" title="Copy coordinates to clipboard" class="py-2 px-4 text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:ring-indigo-500 shadow-md rounded-md">Copy Coordinates</button>
                    </div>
                    <p id="copyCoordsStatus" class="text-sm text-green-600 mt-2 h-4"></p>
                    <p id="mapSearchStatus" class="hidden"></p>
                </div>
                <div class="flex flex-col items-center"> <h3 class="text-lg font-medium text-gray-800 mb-2 w-full max-w-[1000px]">Uploaded Plan</h3>
                    <div id="planPreview">
                        <p class="text-gray-500 text-sm">Plan preview will appear here.</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                 <div class="form-group">
                    <label for="streetInput" class="block text-sm font-medium text-gray-700 mb-1">Street:</label>
                    <input type="text" id="streetInput" placeholder="Enter street name from map" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                 <div class="form-group">
                    <label for="townInput" class="block text-sm font-medium text-gray-700 mb-1">Town:</label>
                    <input type="text" id="townInput" placeholder="Enter town name from map" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                 <div class="form-group">
                    <label for="workDays" class="block text-sm font-medium text-gray-700 mb-1">Number of Working Days:</label>
                    <input type="number" id="workDays" min="1" value="1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                 <div class="form-group">
                    <label for="affectedHouses" class="block text-sm font-medium text-gray-700 mb-1">Required Letters:</label> <input type="number" id="affectedHouses" min="0" max="40" placeholder="e.g., 15" class="mt-1 block w-full px-3 py-2 bg-white border-2 border-[#c31f33] rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"> </div>
                 <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reference Number:</label>
                    <input type="text" id="refNumberDisplay" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                 </div>
                 <div class="form-group">
                     <label class="block text-sm font-medium text-gray-700 mb-1">Date (adjusted):</label>
                     <input type="text" id="dateDisplay" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                 </div>
                 <div class="form-group md:col-span-2">
                     <label class="block text-sm font-medium text-gray-700 mb-1">Coordinates (extracted Lat, Lon):</label>
                     <input type="text" id="coordsDisplay" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                 </div>
            </div>

             <div class="mt-8 flex justify-between">
                 <button class="secondary-button inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="showStep('step1')">Back</button>
                <button id="generateNoticeBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Next: Generate Notice</button>
            </div>
        </div>

        <div id="step4" class="step">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Step 3: Generated Notice Text</h2>
             <p class="mb-4 mt-6 text-sm text-gray-600">Review the generated text below. Copy and paste into your Word template or use the Print button.</p>
            <textarea id="generatedNotice" rows="20" readonly class="w-full p-3 border border-gray-300 rounded bg-gray-50 font-mono text-sm shadow-sm"></textarea>
             <div class="mt-6 flex justify-between items-center">
                 <button class="secondary-button inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="showStep('step3')">Back</button>
                 <div class="flex items-center">
                     <div id="printCopiesDisplay" class="border-2 border-[#c31f33] rounded-md px-4 py-2 text-sm font-medium text-gray-700 mr-4">
                         Print 0 </div>
                    <button id="printNoticeBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Print Notice</button>
                 </div>
            </div>
             <p id="copyStatus" class="text-sm text-green-600 mt-2 text-right"></p>
        </div>

    </div> <div id="noticePrintArea">
        <div class="logo-container">
             <img id="print-logo-img" src="https://raw.githubusercontent.com/RTMOffice/notice-tool/refs/heads/main/Logo.jpg" alt="Company Logo">
        </div>
        <div class="address-block print-text-10pt">
            <div>I & A Communications</div>
            <div>Burgon House</div>
            <div>James Swallow Way</div>
            <div>London and Medway Commercial</div>
            <div>Rochester</div>
            <div>Kent</div>
            <div>ME3 9GX</div>
            <div class="mt-4">Tel:     0845 200 4035</div>
        </div>
        <div class="clear-both mb-10"></div>

        <div class="mt-15 font-times print-text-22pt font-bold" id="print-please-note">PLEASE NOTE</div>
        <div class="mt-4 print-text-24pt underline text-center" id="print-date">On DATE</div>
        <p class="mt-10 print-text-11pt" id="print-para1">
            I&A Communications working on behalf of BT Openreach are responsible for maintaining the network that provides you with your communications service regardless of which telephony or broadband supplier you are using and have been tasked in replacing a BT pole along <strong class="font-bold" id="print-para1-street-town">STREET, TOWN</strong>.
        </p>
        <p class="print-text-11pt" id="print-para2">
            The work is expected to take a maximum of <strong class="font-bold" id="print-para2-days">DAY working days</strong> and during this time there will be a road closure in place. Access will be maintained for residents, but we ask for your patience while our engineers make way as this can take some time, alternatively you can follow our diversion <strong class="font-bold" id="print-para2-div">DIV</strong> and Vice Versa.
        </p>
        <p class="print-text-11pt" id="print-para3">
            <strong class="font-bold" id="print-para3-street-town">STREET, TOWN</strong> will be closed during the hours of 09:00am and 17:00pm, the road will be reopened outside these times.
        </p>
        <p class="print-text-11pt font-bold" id="print-apology">
            We would like to apologise if this work causes any inconvenience and would also like to thank you in advance for your co-operation.
        </p>
        <p class="print-text-12pt" id="print-concerns">
             ANY CONCERNS PLEASE CALL <strong class="font-bold" id="print-concerns-phone">0845 200 4035</strong> WITH OUR REF: <span id="print-concerns-ref">REFR</span>
        </p>
        <div class="mt-10 print-text-11pt" id="print-closing">
            <p>Regards</p>
            <p class="mt-4">Zoe Franks</p>
            <p>I & A Communications Ltd</p>
            <p>Tel: 0845 200 4035</p>
        </div>
    </div>


    <script>
        // --- Global Variables ---
        let planFileUrl = null;
        let noticeData = { ref: '', lat: '', lon: '', date: '', street: '', town: '', days: '1', diversion: '', houses: '' }; // Added town
        let dataParsed = false;
        let planUploaded = false;
        // jsPDF removed

        // --- DOM Elements ---
        const steps = document.querySelectorAll('.step');
        const pasteArea = document.getElementById('pasteArea');
        const pasteError = document.getElementById('pasteError');
        const pasteSuccess = document.getElementById('pasteSuccess');
        // logo elements removed
        const planFileInput = document.getElementById('planFile');
        const planPreview = document.getElementById('planPreview');
        const planError = document.getElementById('planError');
        const planSuccess = document.getElementById('planSuccess');
        const diversionRouteStep1Input = document.getElementById('diversionRouteStep1');
        const mapFrame = document.getElementById('mapFrame');
        const mapSearchStatus = document.getElementById('mapSearchStatus');
        const streetInput = document.getElementById('streetInput'); // New Street Input
        const townInput = document.getElementById('townInput'); // New Town Input
        const workDaysInput = document.getElementById('workDays');
        const affectedHousesInput = document.getElementById('affectedHouses');
        const refNumberDisplay = document.getElementById('refNumberDisplay');
        const dateDisplay = document.getElementById('dateDisplay');
        const coordsDisplay = document.getElementById('coordsDisplay');
        const copyCoordsBtn = document.getElementById('copyCoordsBtn'); // Updated ID
        const copyCoordsStatus = document.getElementById('copyCoordsStatus');
        const generatedNoticeTextarea = document.getElementById('generatedNotice');
        const copyNoticeBtn = document.getElementById('copyNoticeBtn'); // Kept for now, but hidden
        const printNoticeBtn = document.getElementById('printNoticeBtn'); // Changed ID
        const copyStatus = document.getElementById('copyStatus');
        const printCopiesDisplay = document.getElementById('printCopiesDisplay'); // Added element

        // --- Navigation Buttons ---
        const parseAndNextBtn = document.getElementById('parseAndNextBtn');
        const nextToStep3CombinedBtn = document.getElementById('nextToStep3Combined');
        const generateNoticeBtn = document.getElementById('generateNoticeBtn');

        // --- Functions ---

        function showStep(stepId) {
            console.log("Showing step:", stepId);
            steps.forEach(step => {
                step.style.display = (step.id === stepId) ? 'block' : 'none';
            });
            window.scrollTo(0, 0);
        }

        function checkEnableStep1NextButton() {
            // Requires data parsed AND plan uploaded (logo is now hardcoded)
            if (dataParsed && planUploaded) {
                nextToStep3CombinedBtn.disabled = false;
                console.log("Next button enabled.");
            } else {
                 nextToStep3CombinedBtn.disabled = true;
                 console.log("Next button disabled. Data Parsed:", dataParsed, "Plan Uploaded:", planUploaded);
            }
        }

        function getDaySuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return "st";
                case 2: return "nd";
                case 3: return "rd";
                default: return "th";
            }
        }

        function parsePastedData() {
            console.log("parsePastedData called");
            pasteError.textContent = '';
            pasteSuccess.textContent = '';
            dataParsed = false;
            checkEnableStep1NextButton();
            const pastedText = pasteArea.value.trim();
            if (!pastedText) { pasteError.textContent = 'Please paste data.'; return; }
            const columns = pastedText.split('\t');
            if (columns.length <= 15) { pasteError.textContent = `Error: Need at least 16 columns (found ${columns.length}).`; return; }

            try {
                // Date Extraction, Adjustment, and Formatting
                let rawDate = columns[0]?.trim();
                if (!rawDate) throw new Error("Date (Col A) missing.");
                let parsedDate;
                let tempDate = new Date(rawDate);
                if (!isNaN(tempDate.getTime())) { parsedDate = tempDate; }
                else {
                    const dateParts = rawDate.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
                    if (dateParts) {
                        const day = parseInt(dateParts[1], 10), month = parseInt(dateParts[2], 10) - 1;
                        let year = parseInt(dateParts[3], 10); if (year < 100) year += 2000;
                        parsedDate = new Date(Date.UTC(year, month, day));
                        if (isNaN(parsedDate.getTime())) throw new Error(`Invalid date format: "${rawDate}".`);
                    } else {
                        const potentialSerial = Number(rawDate);
                        if (!isNaN(potentialSerial) && potentialSerial > 1 && potentialSerial < 2958466) {
                            const excelEpochOffset = 25569;
                            const jsTimestamp = (potentialSerial - excelEpochOffset) * 86400 * 1000;
                            parsedDate = new Date(jsTimestamp);
                            if (isNaN(parsedDate.getTime())) throw new Error(`Invalid date format: "${rawDate}".`);
                        } else { throw new Error(`Invalid date format: "${rawDate}".`); }
                    }
                }
                const today = new Date(), currentYear = today.getFullYear();
                const comparisonDate = new Date(Date.UTC(currentYear, parsedDate.getUTCMonth(), parsedDate.getUTCDate()));
                const todayDateOnly = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
                let finalYear = comparisonDate < todayDateOnly ? currentYear + 1 : currentYear;
                parsedDate.setUTCFullYear(finalYear);
                const dayOfMonth = parsedDate.getUTCDate();
                const weekday = parsedDate.toLocaleDateString('en-GB', { weekday: 'long' }).toUpperCase();
                const month = parsedDate.toLocaleDateString('en-GB', { month: 'long' }).toUpperCase();
                const year = parsedDate.getUTCFullYear();
                const dayWithSuffix = dayOfMonth + getDaySuffix(dayOfMonth);
                noticeData.date = `${weekday} ${dayWithSuffix} ${month} ${year}`; // Formatted Date

                // Reference
                noticeData.ref = columns[7]?.trim() || '[REF MISSING]';
                if (noticeData.ref === '[REF MISSING]') throw new Error("Ref (Col H) missing.");

                // Location & Coordinates
                let locationString = columns[15]?.trim();
                if (!locationString) throw new Error("Location (Col P) missing.");
                if (locationString.includes('/')) locationString = locationString.split('/')[0].trim();
                const coordRegex = /.*?(-?\d{1,3}(?:\.\d+)?)\s*,\s*(-?\d{1,3}(?:\.\d+)?)/;
                const match = locationString.match(coordRegex);
                if (match && match[1] && match[2]) {
                    const lat = parseFloat(match[1]), lon = parseFloat(match[2]);
                    if (lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
                        noticeData.lat = String(lat); noticeData.lon = String(lon);
                    } else { throw new Error(`Coords out of range (${lat}, ${lon}).`); }
                } else { throw new Error("Couldn't find Lat, Lon in Col P."); }

                console.log("Parsed Data:", noticeData);
                pasteSuccess.textContent = 'Data parsed successfully!';
                dataParsed = true;
                checkEnableStep1NextButton();

            } catch (error) {
                console.error("Parsing error:", error);
                pasteError.textContent = `Error: ${error.message}`;
                dataParsed = false;
                checkEnableStep1NextButton();
                noticeData = { ref: '', lat: '', lon: '', date: '', street: '', town: '', days: '1', diversion: '', houses: '' }; // Reset town too
            }
        }

         // handleLogoUpload removed

        function handlePlanUpload(event) {
            console.log("handlePlanUpload started");
            const file = event.target.files[0];
            planError.textContent = '';
            planSuccess.textContent = '';
            planUploaded = false;
            checkEnableStep1NextButton();
            planPreview.innerHTML = '<p class="text-gray-500 text-sm">Processing plan...</p>';

            if (planFileUrl) { URL.revokeObjectURL(planFileUrl); planFileUrl = null; }
            if (!file) {
                planPreview.innerHTML = '<p class="text-gray-500 text-sm">No plan selected.</p>';
                console.log("No file selected, exiting handlePlanUpload.");
                return;
            }
             console.log("File selected:", file.name, "Type:", file.type);

            try {
                 planFileUrl = URL.createObjectURL(file);
                 console.log("Object URL created:", planFileUrl);
            } catch (e) {
                 console.error("URL Creation Error:", e);
                 planError.textContent = 'Could not create URL for the file.';
                 planPreview.innerHTML = '<p class="text-red-500 text-sm">Error loading preview.</p>';
                 planUploaded = false;
                 checkEnableStep1NextButton();
                 return;
            }

            if (file.type.startsWith('image/')) {
                console.log("File type is image. Creating image preview...");
                const img = document.createElement('img');
                img.src = planFileUrl;
                img.alt = "Plan Preview";
                img.onerror = () => {
                    console.error("Image onerror triggered.");
                    planError.textContent = 'Could not display image.';
                    planPreview.innerHTML = '<p class="text-red-500 text-sm">Error loading image preview.</p>';
                    URL.revokeObjectURL(planFileUrl); planFileUrl = null;
                    planUploaded = false;
                    checkEnableStep1NextButton();
                };
                img.onload = () => {
                    console.log("Image onload triggered.");
                    planPreview.innerHTML = ''; planPreview.appendChild(img);
                    planSuccess.textContent = `Image Plan "${file.name}" ready.`;
                    planUploaded = true;
                    checkEnableStep1NextButton();
                };
            } else if (file.type === 'application/pdf') {
                 console.log("File type is PDF. Creating PDF iframe...");
                planPreview.innerHTML = '';
                const iframe = document.createElement('iframe');
                iframe.src = planFileUrl;
                iframe.title = "Plan PDF Preview";
                iframe.setAttribute('type', 'application/pdf');
                iframe.onload = () => {
                    console.log("PDF iframe onload triggered.");
                    planSuccess.textContent = `PDF Plan "${file.name}" ready for preview above.`;
                    planUploaded = true;
                    checkEnableStep1NextButton();
                };
                 iframe.onerror = () => {
                    console.error("PDF iframe onerror triggered.");
                    planError.textContent = 'Could not load PDF preview in iframe.';
                    planPreview.innerHTML = '<p class="text-red-500 text-sm">Error loading PDF preview.</p>';
                    URL.revokeObjectURL(planFileUrl); planFileUrl = null;
                    planUploaded = false;
                    checkEnableStep1NextButton();
                };
                planPreview.appendChild(iframe);
                 console.log("PDF iframe appended.");
            } else {
                 console.warn("Unsupported file type:", file.type);
                planError.textContent = 'Unsupported file type (Image or PDF only).';
                planPreview.innerHTML = '<p class="text-red-500 text-sm">Invalid file type.</p>';
                URL.revokeObjectURL(planFileUrl); planFileUrl = null;
                planUploaded = false;
                checkEnableStep1NextButton();
            }
        }

        function updateMap() {
            if (noticeData.lat && noticeData.lon) {
                // Revert to ArcGIS Map URL
                const mapUrl = `https://symology.maps.arcgis.com/apps/webappviewer/index.html?id=1055c1d3a2c344cea5353d8ed744831c&center=${noticeData.lon},${noticeData.lat}&level=15`;
                mapFrame.src = mapUrl;
                console.log("Updated map URL to ArcGIS:", mapUrl);
            } else {
                mapFrame.src = 'about:blank';
            }
        }

        function tryAutoFillMapSearch() {
             // Attempt to auto-fill ArcGIS map search
             const coordsString = coordsDisplay.value;
             if (!coordsString || coordsString === 'N/A') return;
             console.log('Attempting auto-fill ArcGIS map...');
             setTimeout(() => {
                 try {
                     const iframeDoc = mapFrame.contentWindow?.document;
                     if (!iframeDoc) throw new Error("Cannot access iframe content.");
                     // Use the specific ID for the ArcGIS search box
                     const searchInput = iframeDoc.getElementById('esri_dijit_Search_0_input');
                     if (searchInput) {
                         searchInput.value = coordsString;
                         // Optionally trigger an input event if needed by ArcGIS
                         // searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                         console.log("Attempted ArcGIS map search auto-fill.");
                     } else { throw new Error("ArcGIS map search input 'esri_dijit_Search_0_input' not found."); }
                 } catch (error) {
                     console.warn("ArcGIS Auto-fill failed:", error.message);
                 }
             }, 3000); // Wait for map to potentially load
        }

        function copyCoordinatesToClipboard() {
            const coordsString = coordsDisplay.value;
            copyCoordsStatus.textContent = '';
            if (!coordsString || coordsString === 'N/A') { copyCoordsStatus.textContent = 'No coordinates to copy.'; return; }
            if (!navigator.clipboard || !navigator.clipboard.writeText) { copyCoordsStatus.textContent = 'Clipboard API not available (try manual copy). Needs HTTPS or localhost.'; return; }
            navigator.clipboard.writeText(coordsString).then(() => {
                copyCoordsStatus.textContent = 'Coordinates copied!';
                setTimeout(() => { copyCoordsStatus.textContent = ''; }, 3000);
            }).catch(err => {
                console.error('Failed to copy coordinates:', err);
                copyCoordsStatus.textContent = 'Copy failed. Check browser permissions or use HTTPS/localhost.';
            });
        }

        /**
         * Populates the hidden print area and the visible textarea.
         */
        function generateNotice() {
             // Read Street and Town from new inputs
             noticeData.street = streetInput.value.trim() || '[STREET MISSING]';
             noticeData.town = townInput.value.trim() || '[TOWN MISSING]';
             const streetAndTown = `${noticeData.street}, ${noticeData.town}`; // Combine for display

             noticeData.days = workDaysInput.value || '1';
             noticeData.houses = affectedHousesInput.value || '0'; // Default to 0 if empty

             if (noticeData.street === '[STREET MISSING]' || noticeData.town === '[TOWN MISSING]') {
                 alert("Please enter both Street and Town names.");
                 if (noticeData.street === '[STREET MISSING]') streetInput.focus();
                 else townInput.focus();
                 return;
             }
             if (!noticeData.diversion) { alert("Please go back and enter the Diversion Route in Step 1."); showStep('step1'); diversionRouteStep1Input.focus(); return; }

             // --- Populate Hidden Print Area ---
             document.getElementById('print-date').textContent = `On ${noticeData.date}`;
             document.getElementById('print-para1-street-town').textContent = streetAndTown;
             document.getElementById('print-para2-days').textContent = `${noticeData.days} working days`;
             document.getElementById('print-para2-div').textContent = noticeData.diversion;
             document.getElementById('print-para3-street-town').textContent = streetAndTown;
             document.getElementById('print-concerns-ref').textContent = noticeData.ref;
             // Logo src is set directly in HTML

             // --- Populate Visible Textarea (for reference/copy) ---
             let textPreview = `I & A Communications Ltd\n\n`;
             textPreview += `Tel: 0845 200 4035\n\n`;
             textPreview += `PLEASE NOTE\n`;
             textPreview += `On ${noticeData.date}\n\n`;
             textPreview += `I&A Communications working on behalf of BT Openreach are responsible for maintaining the network that provides you with your communications service regardless of which telephony or broadband supplier you are using and have been tasked in replacing a BT pole along ${streetAndTown}.\n\n`;
             textPreview += `The work is expected to take a maximum of ${noticeData.days} working days and during this time there will be a road closure in place. Access will be maintained for residents, but we ask for your patience while our engineers make way as this can take some time, alternatively you can follow our diversion ${noticeData.diversion} and Vice Versa.\n\n`;
             textPreview += `${streetAndTown} will be closed during the hours of 09:00am and 17:00pm, the road will be reopened outside these times.\n\n`;
             textPreview += `We would like to apologise if this work causes any inconvenience and would also like to thank you in advance for your co-operation.\n\n`;
             textPreview += `ANY CONCERNS PLEASE CALL 0845 200 4035 WITH OUR REF: ${noticeData.ref}\n\n`;
             textPreview += `Regards\nZoe Franks\nI & A Communications Ltd\nTel: 0845 200 4035`;

             generatedNoticeTextarea.value = textPreview;

             // --- Populate Print Copies Display Box ---
             const numHouses = parseInt(noticeData.houses, 10) || 0;
             printCopiesDisplay.textContent = `Print ${numHouses}`; // Update the new display box

             showStep('step4');
        }

        function copyNoticeToClipboard() {
            generatedNoticeTextarea.select();
            generatedNoticeTextarea.setSelectionRange(0, 99999);
            copyStatus.textContent = '';
            if (!navigator.clipboard || !navigator.clipboard.writeText) { copyStatus.textContent = 'Clipboard API not available (try manual copy).'; return; }
            navigator.clipboard.writeText(generatedNoticeTextarea.value)
                .then(() => { copyStatus.textContent = 'Notice text copied!'; setTimeout(() => { copyStatus.textContent = ''; }, 3000); })
                .catch(err => { console.error('Failed to copy notice:', err); copyStatus.textContent = 'Copy failed.'; });
        }

        /**
         * Triggers the browser's print dialog.
         */
        function printNotice() {
            window.print();
        }


        // --- Event Listeners ---
        parseAndNextBtn.addEventListener('click', parsePastedData);
        // logoFileInput listener removed
        planFileInput.addEventListener('change', handlePlanUpload);
        copyCoordsBtn.addEventListener('click', copyCoordinatesToClipboard); // Updated ID

        nextToStep3CombinedBtn.addEventListener('click', () => {
            noticeData.diversion = diversionRouteStep1Input.value.trim();
            if (!noticeData.diversion) { alert("Please enter the diversion route before proceeding."); diversionRouteStep1Input.focus(); return; }
            if (!dataParsed || !planUploaded) { alert("Please ensure data is parsed and a plan is uploaded successfully before proceeding."); console.error("Proceed clicked but flags not set. Data Parsed:", dataParsed, "Plan Uploaded:", planUploaded); return; }

            updateMap(); // Update map URL
            refNumberDisplay.value = noticeData.ref;
            dateDisplay.value = noticeData.date; // Display formatted date
            coordsDisplay.value = noticeData.lat && noticeData.lon ? `${noticeData.lat}, ${noticeData.lon}` : 'N/A';
            showStep('step3');
            tryAutoFillMapSearch(); // Attempt auto-fill for ArcGIS
        });

        generateNoticeBtn.addEventListener('click', generateNotice);
        // copyNoticeBtn listener removed
        // Changed listener to call print function
        printNoticeBtn.addEventListener('click', printNotice);

        // --- Initialisation ---
        showStep('step1');

    </script>

</body>
</html>
