<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notice Generation Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* Basic styling - Minimal CSS needed now */
        body { font-family: 'Inter', sans-serif; }
        /* Set base height for iframes within containers */
        iframe { width: 100%; height: 100%; border: 1px solid #ccc; border-radius: 0.375rem; } /* Set height 100% */

        /* Style for the plan preview area */
        #planPreview {
             border: 1px solid #ccc; border-radius: 0.375rem;
             display: flex; justify-content: center; align-items: center;
             overflow: hidden; background-color: #f9fafb; padding: 0;
             text-align: center;
             width: 100%; /* Takes width of parent grid cell */
             height: 500px; /* Set fixed height */
        }
        #planPreview img { max-width: 100%; max-height: 100%; object-fit: contain; display: block; margin: auto; }
        /* Style for the plan PDF preview (iframe) */
        #planPreview iframe { width: 100%; height: 100%; border: none; border-radius: 0.375rem; }

        /* Container for map iframe and overlay button */
        .map-container {
            position: relative; /* Needed for absolute positioning of children */
            width: 100%; /* Takes width of parent grid cell */
            height: 500px; /* Set fixed height */
        }
        .map-container iframe {
             position: absolute;
             top: 0; left: 0; width: 100%; height: 100%; /* Make iframe fill container */
        }
        /* Overlay button style - using Tailwind classes directly now */
        #copyCoordsBtnOverlay {
            position: absolute;
            top: 10px; /* 10px from top */
            left: 50%; /* Center horizontally */
            transform: translateX(-50%); /* Adjust horizontal centering */
            z-index: 10; /* Ensure it's above the iframe */
            /* Tailwind classes applied directly in HTML */
        }

        /* Hide steps initially */
        .step { display: none; }
        #step1 { display: block; }

        /* Add a subtle border between form groups in Step 1 */
        #step1 .form-group + .form-group {
            border-top: 1px solid #e5e7eb; /* Tailwind gray-200 */
            padding-top: 1.5rem; /* Add padding above the border */
            margin-top: 1.5rem; /* Keep margin consistent */
        }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4">

    <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8 bg-white rounded-lg shadow-lg border border-gray-200">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Notice Generation Tool (Ver 13)</h1>

        <div id="step1" class="step space-y-6"> {/* Added space-y for default spacing */}
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Step 1: Data collection</h2>

            <div class="form-group bg-blue-50 p-4 rounded-md border border-blue-200">
                <label for="pasteArea" class="block text-sm font-bold text-gray-700 mb-1">Copy and paste job row from planned WB</label>
                <p class="text-xs text-gray-600 mb-2">Date (Col A), Job (Col H), Location (Col P).</p>
                <textarea id="pasteArea" placeholder="Paste row data here..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm font-mono min-h-[80px]"></textarea>
                <button id="parseAndNextBtn" class="mt-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">Parse Pasted Data</button>
                <p id="pasteError" class="text-red-600 text-sm mt-2"></p>
                <p id="pasteSuccess" class="text-green-600 text-sm mt-2"></p>
            </div>

            <div class="form-group bg-green-50 p-4 rounded-md border border-green-200">
               <label for="planFile" class="block text-sm font-bold text-gray-700 mb-1">Upload TM Plan</label>
               <input type="file" id="planFile" accept="image/*,application/pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <p class="text-xs text-gray-600 mt-1">Accepts images or PDF. PDF viewing requires a browser viewer/extension.</p>
                <p id="planError" class="text-red-600 text-sm mt-2"></p>
                <p id="planSuccess" class="text-green-600 text-sm mt-2"></p>
           </div>

            <div class="form-group bg-yellow-50 p-4 rounded-md border border-yellow-200">
                <label for="diversionRouteStep1" class="block text-sm font-bold text-gray-700 mb-1">Enter diversion route</label>
                <textarea id="diversionRouteStep1" rows="3" placeholder="Enter diversion route details..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
            </div>

             <div class="mt-8 text-right"> {/* Increased top margin */}
                 <button id="nextToStep3Combined" disabled class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">Next: Review Map & Plan</button>
             </div>
        </div>

        <div id="step3" class="step">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Step 2: Review Map/Plan & Enter Details</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6 mb-6 mt-6">
                <div class="mb-4 md:mb-0"> {/* Grid column 1 */}
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Map Location</h3>
                    <div class="map-container"> {/* Height applied here */}
                        <iframe id="mapFrame" src="about:blank" title="Location Map" class="w-full h-full"></iframe>
                        <button id="copyCoordsBtnOverlay" title="Copy coordinates to clipboard" class="py-1 px-2 text-xs border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:ring-indigo-500 shadow-md rounded-md">Copy Coords</button>
                    </div>
                     </div>
                <div> {/* Grid column 2 */}
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Uploaded Plan</h3>
                    <div id="planPreview"> {/* Height applied here */}
                        <p class="text-gray-500 text-sm">Plan preview will appear here.</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8"> {/* Increased gap and top margin */}
                 <div class="form-group">
                    <label for="streetName" class="block text-sm font-medium text-gray-700 mb-1">Street Name:</label>
                    <input type="text" id="streetName" placeholder="Enter street name from map" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                 <div class="form-group">
                    <label for="workDays" class="block text-sm font-medium text-gray-700 mb-1">Number of Working Days:</label>
                    <input type="number" id="workDays" min="1" value="1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="form-group">
                    <label for="affectedHouses" class="block text-sm font-medium text-gray-700 mb-1">Affected Houses (approx):</label>
                    <input type="number" id="affectedHouses" min="0" max="40" placeholder="e.g., 15" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                 <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reference Number:</label>
                    <input type="text" id="refNumberDisplay" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                 </div>
                 <div class="form-group">
                     <label class="block text-sm font-medium text-gray-700 mb-1">Date (adjusted):</label>
                     <input type="text" id="dateDisplay" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                 </div>
                 <div class="form-group md:col-span-2">
                     <label class="block text-sm font-medium text-gray-700 mb-1">Coordinates (extracted Lat, Lon):</label>
                     <input type="text" id="coordsDisplay" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                     <p id="copyCoordsStatus" class="text-sm text-green-600 mt-1"></p>
                     <p id="mapSearchStatus" class="hidden"></p>
                 </div>
            </div>

             <div class="mt-8 flex justify-between"> {/* Increased top margin */}
                 <button class="secondary-button inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="showStep('step1')">Back</button>
                <button id="generateNoticeBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Next: Generate Notice</button>
            </div>
        </div>

        <div id="step4" class="step">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Step 3: Generated Notice Text</h2>
             <p class="mb-4 mt-6 text-sm text-gray-600">Review the generated text below. Copy and paste into your Word template.</p>
            <textarea id="generatedNotice" rows="20" readonly class="w-full p-3 border border-gray-300 rounded bg-gray-50 font-mono text-sm shadow-sm"></textarea>
             <div class="mt-6 flex justify-between items-center">
                 <button class="secondary-button inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="showStep('step3')">Back</button>
                 <div>
                    <button id="copyNoticeBtn" class="mr-2 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Copy Text</button>
                    <button id="downloadNoticeBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Download as .txt</button>
                 </div>
            </div>
             <p id="copyStatus" class="text-sm text-green-600 mt-2 text-right"></p>
        </div>

    </div>

    <script>
        // --- Global Variables ---
        let planFileUrl = null;
        let noticeData = { ref: '', lat: '', lon: '', date: '', street: '', days: '1', diversion: '', houses: '' };
        // Flags to track completion
        let dataParsed = false;
        let planUploaded = false;

        // --- DOM Elements ---
        const steps = document.querySelectorAll('.step');
        const pasteArea = document.getElementById('pasteArea');
        const pasteError = document.getElementById('pasteError');
        const pasteSuccess = document.getElementById('pasteSuccess');
        const planFileInput = document.getElementById('planFile');
        const planPreview = document.getElementById('planPreview');
        const planError = document.getElementById('planError');
        const planSuccess = document.getElementById('planSuccess');
        const diversionRouteStep1Input = document.getElementById('diversionRouteStep1'); // New input
        const mapFrame = document.getElementById('mapFrame');
        const mapSearchStatus = document.getElementById('mapSearchStatus');
        const streetNameInput = document.getElementById('streetName');
        // Diversion route input in step 3 is removed
        const workDaysInput = document.getElementById('workDays');
        const affectedHousesInput = document.getElementById('affectedHouses');
        const refNumberDisplay = document.getElementById('refNumberDisplay');
        const dateDisplay = document.getElementById('dateDisplay');
        const coordsDisplay = document.getElementById('coordsDisplay');
        const copyCoordsBtnOverlay = document.getElementById('copyCoordsBtnOverlay');
        const copyCoordsStatus = document.getElementById('copyCoordsStatus');
        const generatedNoticeTextarea = document.getElementById('generatedNotice');
        const copyNoticeBtn = document.getElementById('copyNoticeBtn');
        const downloadNoticeBtn = document.getElementById('downloadNoticeBtn');
        const copyStatus = document.getElementById('copyStatus');

        // --- Navigation Buttons ---
        const parseAndNextBtn = document.getElementById('parseAndNextBtn'); // Button to trigger parsing
        const nextToStep3CombinedBtn = document.getElementById('nextToStep3Combined'); // Combined next button
        const generateNoticeBtn = document.getElementById('generateNoticeBtn');

        // --- Template Text ---
        const noticeTemplate = `
I & A Communications Ltd

Tel: 0845 200 4035

PLEASE NOTE
On DAY 2025
I&A Communications working on behalf of BT Openreach are responsible for maintaining the network that provides you with your communications service regardless of which telephony or broadband supplier you are using and have been tasked in replacing a BT pole along STREET

The work is expected to take a maximum of DAY working days and during this time there will be a road closure in place. Access will be maintained for residents, but we ask for your patience while our engineers make way as this can take some time, alternatively you can follow our diversion DIV and Vice Versa.

STREET will be closed during the hours of 09:00am and 17:00pm, the road will be reopened outside these times.

We would like to apologise if this work causes any inconvenience and would also like to thank you in advance for your co-operation.

ANY CONCERNS PLEASE CALL 0845 200 4035 WITH OUR REF: REFR

Regards
Zoe Franks
I & A Communications Ltd
Tel: 0845 200 4035
        `;

        // --- Functions ---

        function showStep(stepId) {
            console.log("Showing step:", stepId);
            steps.forEach(step => {
                step.style.display = (step.id === stepId) ? 'block' : 'none';
            });
            window.scrollTo(0, 0);
        }

        /**
         * Checks if both data parsing and plan upload are complete to enable the main next button.
         */
        function checkEnableStep1NextButton() {
            // Button should be enabled if both data is parsed AND plan is uploaded
            if (dataParsed && planUploaded) {
                nextToStep3CombinedBtn.disabled = false;
                console.log("Next button enabled.");
            } else {
                 nextToStep3CombinedBtn.disabled = true;
                 console.log("Next button disabled. Data Parsed:", dataParsed, "Plan Uploaded:", planUploaded);
            }
        }


        function parsePastedData() {
            console.log("parsePastedData called");
            pasteError.textContent = '';
            pasteSuccess.textContent = '';
            dataParsed = false; // Reset flag
            checkEnableStep1NextButton(); // Disable button until success
            const pastedText = pasteArea.value.trim();
            if (!pastedText) { pasteError.textContent = 'Please paste data.'; return; }
            const columns = pastedText.split('\t');
            if (columns.length <= 15) { pasteError.textContent = `Error: Need at least 16 columns (found ${columns.length}).`; return; }

            try {
                // Date Extraction and Adjustment
                let rawDate = columns[0]?.trim();
                if (!rawDate) throw new Error("Date (Col A) missing.");
                let parsedDate;
                let tempDate = new Date(rawDate);
                if (!isNaN(tempDate.getTime())) { parsedDate = tempDate; }
                else {
                    const dateParts = rawDate.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
                    if (dateParts) {
                        const day = parseInt(dateParts[1], 10), month = parseInt(dateParts[2], 10) - 1;
                        let year = parseInt(dateParts[3], 10); if (year < 100) year += 2000;
                        parsedDate = new Date(Date.UTC(year, month, day));
                        if (isNaN(parsedDate.getTime())) throw new Error(`Invalid date format: "${rawDate}".`);
                    } else {
                        const potentialSerial = Number(rawDate);
                        if (!isNaN(potentialSerial) && potentialSerial > 1 && potentialSerial < 2958466) {
                            const excelEpochOffset = 25569;
                            const jsTimestamp = (potentialSerial - excelEpochOffset) * 86400 * 1000;
                            parsedDate = new Date(jsTimestamp);
                            if (isNaN(parsedDate.getTime())) throw new Error(`Invalid date format: "${rawDate}".`);
                        } else { throw new Error(`Invalid date format: "${rawDate}".`); }
                    }
                }
                const today = new Date(), currentYear = today.getFullYear();
                const comparisonDate = new Date(Date.UTC(currentYear, parsedDate.getUTCMonth(), parsedDate.getUTCDate()));
                const todayDateOnly = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
                let finalYear = comparisonDate < todayDateOnly ? currentYear + 1 : currentYear;
                parsedDate.setUTCFullYear(finalYear);
                noticeData.date = `${('0' + parsedDate.getUTCDate()).slice(-2)}/${('0' + (parsedDate.getUTCMonth() + 1)).slice(-2)}/${parsedDate.getUTCFullYear()}`;

                // Reference
                noticeData.ref = columns[7]?.trim() || '[REF MISSING]';
                if (noticeData.ref === '[REF MISSING]') throw new Error("Ref (Col H) missing.");

                // Location & Coordinates
                let locationString = columns[15]?.trim();
                if (!locationString) throw new Error("Location (Col P) missing.");
                if (locationString.includes('/')) locationString = locationString.split('/')[0].trim();
                const coordRegex = /.*?(-?\d{1,3}(?:\.\d+)?)\s*,\s*(-?\d{1,3}(?:\.\d+)?)/;
                const match = locationString.match(coordRegex);
                if (match && match[1] && match[2]) {
                    const lat = parseFloat(match[1]), lon = parseFloat(match[2]);
                    if (lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
                        noticeData.lat = String(lat); noticeData.lon = String(lon);
                    } else { throw new Error(`Coords out of range (${lat}, ${lon}).`); }
                } else { throw new Error("Couldn't find Lat, Lon in Col P."); }

                console.log("Parsed Data:", noticeData);
                pasteSuccess.textContent = 'Data parsed successfully!';
                dataParsed = true; // Set flag on success
                checkEnableStep1NextButton(); // Check if other part is done

            } catch (error) {
                console.error("Parsing error:", error);
                pasteError.textContent = `Error: ${error.message}`;
                dataParsed = false; // Reset flag on error
                checkEnableStep1NextButton(); // Ensure button is disabled
                noticeData = { ref: '', lat: '', lon: '', date: '', street: '', days: '1', diversion: '', houses: '' }; // Reset
            }
        }

        /**
         * Handles plan upload (Image or PDF) and sets up preview (image or iframe).
         */
        function handlePlanUpload(event) {
            console.log("handlePlanUpload started");
            const file = event.target.files[0];
            planError.textContent = '';
            planSuccess.textContent = '';
            planUploaded = false; // Reset flag
            checkEnableStep1NextButton(); // Disable button until success
            // Reset preview area immediately
            planPreview.innerHTML = '<p class="text-gray-500 text-sm">Processing plan...</p>';

            if (planFileUrl) { URL.revokeObjectURL(planFileUrl); planFileUrl = null; }
            if (!file) {
                planPreview.innerHTML = '<p class="text-gray-500 text-sm">No plan selected.</p>';
                console.log("No file selected, exiting handlePlanUpload.");
                return; // Exit if no file is chosen
            }
             console.log("File selected:", file.name, "Type:", file.type);

            try {
                 planFileUrl = URL.createObjectURL(file);
                 console.log("Object URL created:", planFileUrl);
            } catch (e) {
                 console.error("URL Creation Error:", e);
                 planError.textContent = 'Could not create URL for the file.';
                 planPreview.innerHTML = '<p class="text-red-500 text-sm">Error loading preview.</p>';
                 planUploaded = false; // Ensure flag is false
                 checkEnableStep1NextButton();
                 return;
            }

            if (file.type.startsWith('image/')) {
                console.log("File type is image. Creating image preview...");
                const img = document.createElement('img');
                img.src = planFileUrl;
                img.alt = "Plan Preview";
                img.onerror = () => {
                    console.error("Image onerror triggered.");
                    planError.textContent = 'Could not display image.';
                    planPreview.innerHTML = '<p class="text-red-500 text-sm">Error loading image preview.</p>';
                    URL.revokeObjectURL(planFileUrl); planFileUrl = null;
                    planUploaded = false; // Reset flag
                    checkEnableStep1NextButton(); // Ensure button disabled
                };
                img.onload = () => {
                    console.log("Image onload triggered.");
                    planPreview.innerHTML = ''; planPreview.appendChild(img);
                    planSuccess.textContent = `Image Plan "${file.name}" ready.`;
                    planUploaded = true; // Set flag on success
                    checkEnableStep1NextButton(); // Check if other part is done
                };
            } else if (file.type === 'application/pdf') {
                 console.log("File type is PDF. Creating PDF iframe...");
                planPreview.innerHTML = '';
                const iframe = document.createElement('iframe');
                iframe.src = planFileUrl;
                iframe.title = "Plan PDF Preview";
                iframe.setAttribute('type', 'application/pdf');
                // Add an onload for the iframe to be more certain it's ready (though not always reliable for PDFs)
                iframe.onload = () => {
                    console.log("PDF iframe onload triggered (may not indicate PDF rendering success).");
                    planSuccess.textContent = `PDF Plan "${file.name}" ready for preview above.`;
                    planUploaded = true; // Set flag on success (best effort)
                    checkEnableStep1NextButton(); // Check if other part is done
                };
                 iframe.onerror = () => { // Add basic error handling for iframe
                    console.error("PDF iframe onerror triggered.");
                    planError.textContent = 'Could not load PDF preview in iframe.';
                    planPreview.innerHTML = '<p class="text-red-500 text-sm">Error loading PDF preview.</p>';
                    URL.revokeObjectURL(planFileUrl); planFileUrl = null;
                    planUploaded = false; // Reset flag
                    checkEnableStep1NextButton();
                };
                planPreview.appendChild(iframe);
                 console.log("PDF iframe appended.");
                 // Don't enable button here, wait for onload/onerror
            } else {
                 console.warn("Unsupported file type:", file.type);
                planError.textContent = 'Unsupported file type (Image or PDF only).';
                planPreview.innerHTML = '<p class="text-red-500 text-sm">Invalid file type.</p>';
                URL.revokeObjectURL(planFileUrl); planFileUrl = null;
                planUploaded = false; // Reset flag
                checkEnableStep1NextButton(); // Ensure button disabled
            }
        }

        function updateMap() {
            // mapSearchStatus.textContent = ''; // Don't show status
            if (noticeData.lat && noticeData.lon) {
                const mapUrl = `https://symology.maps.arcgis.com/apps/webappviewer/index.html?id=1055c1d3a2c344cea5353d8ed744831c&center=${noticeData.lon},${noticeData.lat}&level=15`;
                mapFrame.src = mapUrl;
            } else {
                mapFrame.src = 'about:blank';
            }
        }

        function tryAutoFillMapSearch() {
             const coordsString = coordsDisplay.value;
             if (!coordsString || coordsString === 'N/A') return;
             // mapSearchStatus.textContent = 'Attempting auto-fill...'; // Don't show status
             console.log('Attempting auto-fill...');
             setTimeout(() => {
                 try {
                     const iframeDoc = mapFrame.contentWindow?.document;
                     if (!iframeDoc) throw new Error("Cannot access iframe content.");
                     const searchInput = iframeDoc.getElementById('esri_dijit_Search_0_input');
                     if (searchInput) {
                         searchInput.value = coordsString;
                         console.log("Attempted map search auto-fill.");
                         // mapSearchStatus.textContent = 'Auto-fill attempted. Verify map.'; // Don't show status
                     } else { throw new Error("Map search input not found."); }
                 } catch (error) {
                     console.warn("Auto-fill failed:", error.message);
                     // mapSearchStatus.textContent = `Auto-fill failed (likely security). Use 'Copy Coords'.`; // Don't show status
                 }
             }, 3000);
        }

        function copyCoordinatesToClipboard() {
            const coordsString = coordsDisplay.value;
            copyCoordsStatus.textContent = '';

            if (!coordsString || coordsString === 'N/A') {
                copyCoordsStatus.textContent = 'No coordinates to copy.';
                return;
            }

            if (!navigator.clipboard || !navigator.clipboard.writeText) {
                copyCoordsStatus.textContent = 'Clipboard API not available (try manual copy). Needs HTTPS or localhost.';
                return;
            }

            navigator.clipboard.writeText(coordsString).then(() => {
                copyCoordsStatus.textContent = 'Coordinates copied!';
                setTimeout(() => { copyCoordsStatus.textContent = ''; }, 3000);
            }).catch(err => {
                console.error('Failed to copy coordinates:', err);
                copyCoordsStatus.textContent = 'Copy failed. Check browser permissions or use HTTPS/localhost.';
            });
        }

        function generateNotice() {
             // Diversion route is already in noticeData from Step 1
             noticeData.street = streetNameInput.value.trim() || '[STREET NAME MISSING]';
             noticeData.days = workDaysInput.value || '1';
             noticeData.houses = affectedHousesInput.value;

             if (noticeData.street === '[STREET NAME MISSING]') { alert("Please enter Street Name."); streetNameInput.focus(); return; }
             if (!noticeData.diversion) { // Check if diversion route was entered in Step 1
                 alert("Please go back and enter the Diversion Route in Step 1.");
                 showStep('step1'); // Go back to step 1
                 diversionRouteStep1Input.focus();
                 return;
             }

             let populatedNotice = noticeTemplate;
             populatedNotice = populatedNotice.replace(/DAY 2025/g, noticeData.date);
             populatedNotice = populatedNotice.replace(/STREET/g, noticeData.street);
             populatedNotice = populatedNotice.replace(/DAY working days/g, `${noticeData.days} working days`);
             populatedNotice = populatedNotice.replace(/DIV/g, noticeData.diversion);
             populatedNotice = populatedNotice.replace(/REFR/g, noticeData.ref);

             generatedNoticeTextarea.value = populatedNotice;
             showStep('step4'); // Show the final step (conceptually Step 3)
        }

        function copyNoticeToClipboard() {
            generatedNoticeTextarea.select();
            generatedNoticeTextarea.setSelectionRange(0, 99999);
            copyStatus.textContent = '';
            if (!navigator.clipboard || !navigator.clipboard.writeText) {
                copyStatus.textContent = 'Clipboard API not available (try manual copy).'; return;
            }
            navigator.clipboard.writeText(generatedNoticeTextarea.value)
                .then(() => { copyStatus.textContent = 'Notice text copied!'; setTimeout(() => { copyStatus.textContent = ''; }, 3000); })
                .catch(err => { console.error('Failed to copy notice:', err); copyStatus.textContent = 'Copy failed.'; });
        }

        function downloadNoticeAsTxt() {
            const textToSave = generatedNoticeTextarea.value;
            const blob = new Blob([textToSave], { type: 'text/plain;charset=utf-8' });
            const filename = `Notice_${noticeData.ref || 'Ref'}_${noticeData.date.replace(/[\/\\]/g, '-') || 'Date'}.txt`;
            saveAs(blob, filename);
        }


        // --- Event Listeners ---
        parseAndNextBtn.addEventListener('click', parsePastedData); // Parse button in Step 1
        planFileInput.addEventListener('change', handlePlanUpload); // Plan upload in Step 1
        copyCoordsBtnOverlay.addEventListener('click', copyCoordinatesToClipboard); // Copy button in Step 3

        // Combined "Next" button from Step 1
        nextToStep3CombinedBtn.addEventListener('click', () => {
            // Get diversion route from Step 1 input
            noticeData.diversion = diversionRouteStep1Input.value.trim();
            if (!noticeData.diversion) {
                alert("Please enter the diversion route before proceeding.");
                diversionRouteStep1Input.focus();
                return; // Stop if diversion route is empty
            }
            // Ensure data parsed and plan uploaded flags are still true (safety check)
            if (!dataParsed || !planUploaded) {
                 alert("Please ensure data is parsed and a plan is uploaded successfully before proceeding.");
                 console.error("Proceed clicked but flags not set. Data Parsed:", dataParsed, "Plan Uploaded:", planUploaded);
                 return;
            }

            // Proceed to Step 3 (Map/Plan review)
            updateMap();
            refNumberDisplay.value = noticeData.ref;
            dateDisplay.value = noticeData.date;
            coordsDisplay.value = noticeData.lat && noticeData.lon ? `${noticeData.lat}, ${noticeData.lon}` : 'N/A';
            showStep('step3');
            tryAutoFillMapSearch();
        });

        generateNoticeBtn.addEventListener('click', generateNotice); // Generate button in Step 3
        copyNoticeBtn.addEventListener('click', copyNoticeToClipboard); // Copy button in Step 4
        downloadNoticeBtn.addEventListener('click', downloadNoticeAsTxt); // Download button in Step 4

        // --- Initialisation ---
        showStep('step1'); // Start at the combined Step 1

    </script>

</body>
</html>

